<!DOCTYPE html>
<html lang="es">
<head>
    
    
    <!-- ‚úÖ URL CORRECTA PARA CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mente Sana - Tu espacio para el bienestar mental</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4A6FA5;
            --primary-light: #6B8CC0;
            --primary-dark: #34568B;
            --secondary: #5DB7DE;
            --secondary-light: #7EC8E3;
            --accent: #FF6B8B;
            --accent-light: #FF8FA3;
            --light: #F8F9FA;
            --light-gray: #E9ECEF;
            --dark: #343A40;
            --success: #51CF66;
            --warning: #FFD43B;
            --danger: #FF6B6B;
            --text: #495057;
            --text-light: #6C757D;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --radius: 12px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content h1 {
            margin-bottom: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .welcome-message {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        nav {
            display: flex;
            justify-content: center;
            background-color: white;
            padding: 0.75rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            display: flex;
            max-width: 1200px;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            gap: 0.5rem;
        }
        
        nav button {
            background: none;
            border: none;
            color: var(--text);
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 50px;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        nav button:hover {
            background-color: var(--light-gray);
            color: var(--primary);
        }
        
        nav button.active {
            background-color: var(--primary);
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            flex: 1;
        }
        
        .section {
            background-color: white;
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: none;
        }
        
        .section:hover {
            box-shadow: var(--shadow-hover);
        }
        
        .active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        h2 i {
            color: var(--accent);
        }
        
        h3 {
            margin: 1.5rem 0 1rem;
            color: var(--primary-dark);
        }
        
        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .emotion {
            background-color: var(--light);
            border-radius: var(--radius);
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .emotion:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .emotion.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }
        
        .emotion-icon {
            font-size: 2rem;
        }
        
        textarea {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius);
            margin: 1rem 0;
            resize: vertical;
            min-height: 120px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 10px rgba(74, 111, 165, 0.3);
        }
        
        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 111, 165, 0.4);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            box-shadow: 0 4px 10px rgba(93, 183, 222, 0.3);
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-light);
        }
        
        .btn-accent {
            background-color: var(--accent);
            box-shadow: 0 4px 10px rgba(255, 107, 139, 0.3);
        }
        
        .btn-accent:hover {
            background-color: var(--accent-light);
        }
        
        .chart-container {
            height: 300px;
            margin: 1.5rem 0;
            background-color: var(--light);
            border-radius: var(--radius);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .exercise-card {
            background-color: var(--light);
            border-radius: var(--radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid var(--secondary);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .exercise-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .exercise-icon {
            font-size: 2rem;
            color: var(--secondary);
        }
        
        .challenge-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .challenge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem;
            border-radius: var(--radius);
            background-color: var(--light);
            transition: var(--transition);
        }
        
        .challenge-item:hover {
            background-color: var(--light-gray);
        }
        
        .challenge-item.completed {
            background-color: rgba(81, 207, 102, 0.1);
            border-left: 4px solid var(--success);
        }
        
        .challenge-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .quote-container {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary-light) 100%);
            border-radius: var(--radius);
            padding: 2rem;
            margin: 1.5rem 0;
            color: white;
            font-style: italic;
            font-size: 1.2rem;
            text-align: center;
            position: relative;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin: 1.5rem 0;
        }
        
        .calendar-header {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .calendar-day {
            background-color: var(--light);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: var(--transition);
        }
        
        .calendar-day:hover {
            background-color: var(--light-gray);
        }
        
        .calendar-day.has-entry {
            background-color: var(--success);
            color: white;
            font-weight: 600;
        }
        
        .calendar-day-number {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .breathing-exercise {
            text-align: center;
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .breathing-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            transition: transform 4s ease-in-out, background 4s ease-in-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .breathing-instruction {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-dark);
            min-height: 2rem;
        }
        
        .pet-container {
            text-align: center;
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .pet {
            font-size: 8rem;
            margin: 1rem 0;
            transition: var(--transition);
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.1));
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes slide {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }
        
        @keyframes fly {
            0%, 100% { transform: translateY(0) rotate(0); }
            25% { transform: translateY(-5px) rotate(5deg); }
            75% { transform: translateY(5px) rotate(-5deg); }
        }
        
        @keyframes hop {
            0%, 100% { transform: translateY(0) scale(1); }
            30% { transform: translateY(-10px) scale(1.05); }
            60% { transform: translateY(0) scale(1); }
        }
        
        .pet-status {
            font-size: 1.2rem;
            color: var(--primary-dark);
            background-color: var(--light);
            padding: 1rem 1.5rem;
            border-radius: 50px;
            display: inline-block;
        }
        
        .pet-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        
        .pet-option {
            cursor: pointer;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
            background-color: var(--light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
        }
        
        .pet-option:hover {
            background-color: var(--light-gray);
            transform: translateY(-3px);
        }
        
        .pet-option.selected {
            background-color: var(--primary);
            color: white;
        }
        
        .pet-icon {
            font-size: 2.5rem;
        }
        
        .pet-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
            margin: 1.5rem 0;
        }
        
        input[type="text"], input[type="email"], input[type="password"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
        }
        
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .hidden {
            display: none;
        }
        
        /* Login/Register Styles */
        .auth-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 1rem;
        }
        
        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        
        /* Footer Styles */
        footer {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            padding: 3rem 1rem 2rem;
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }
        
        .footer-section h3 {
            color: white;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .footer-section h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 2px;
            background-color: var(--secondary);
        }
        
        .footer-section p, .footer-section a {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.8rem;
            display: block;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .footer-section a:hover {
            color: white;
            transform: translateX(5px);
        }
        
        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .social-links a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .footer-bottom {
            max-width: 1200px;
            margin: 2rem auto 0;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Resource Pages Styles */
        .resource-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .resource-card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .resource-image {
            height: 180px;
            background-size: cover;
            background-position: center;
        }
        
        .resource-content {
            padding: 1.5rem;
        }
        
        .resource-content h3 {
            margin-top: 0;
            color: var(--primary);
        }
        
        .resource-content p {
            color: var(--text-light);
            margin-bottom: 1rem;
        }
        
        .resource-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
            font-weight: 500;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .resource-link:hover {
            color: var(--primary-dark);
            gap: 0.7rem;
        }
        
        .article-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .article-item {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .article-item:hover {
            box-shadow: var(--shadow-hover);
        }
        
        .article-item h3 {
            margin-top: 0;
            color: var(--primary);
        }
        
        .article-meta {
            display: flex;
            gap: 1rem;
            margin: 0.5rem 0;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .article-meta span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .help-center-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .help-center-item {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .help-center-item:hover {
            box-shadow: var(--shadow-hover);
        }
        
        .help-center-item h3 {
            margin-top: 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .help-center-info {
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .help-center-info p {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            .section {
                padding: 1.5rem;
            }
            
            .pet {
                font-size: 6rem;
            }
            
            .pet-option {
                min-width: 100px;
                padding: 0.75rem 1rem;
            }
            
            .pet-icon {
                font-size: 2rem;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
            }
            
            .resource-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Profile Styles */
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: 700;
        }
        
        .profile-info h2 {
            margin-bottom: 0.5rem;
        }
        
        .profile-info p {
            color: var(--text-light);
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .profile-stat {
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
        }
        
        .profile-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .profile-stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.3rem;
        }
        
        .profile-form {
            background: var(--light);
            padding: 2rem;
            border-radius: var(--radius);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Estilos adicionales para las nuevas funcionalidades */
        .emotion.selected { 
            border-color: #6e8efb; 
            background-color: #f0f5ff;
        }

        .nota-item {
            background: #f8f9fa;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 4px solid #6e8efb;
        }

        .emotion-badge {
            background: #6e8efb;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 0.5rem 0;
        }

        .stat-bar-fill {
            height: 100%;
            background: #6e8efb;
            border-radius: 3px;
        }

        .reto-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            margin: 0.5rem 0;
            border-radius: 8px;
        }

        .reto-item.completado {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .btn-danger {
            background: #f44336;
        }

        .exercise-active {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin: 1rem 0;
        }

        .breathing-guide {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
        }

        .breathing-step {
            text-align: center;
            padding: 1rem;
        }

        .timer {
            font-size: 3rem;
            text-align: center;
            margin: 2rem 0;
            font-weight: bold;
        }

        .profile-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #6e8efb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin-right: 2rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .profile-stat {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .profile-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #6e8efb;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .resource-content-active {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin: 1rem 0;
        }

        .article, .guide, .forum-topic, .center {
            background: white;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid #6e8efb;
        }

        /* Estilos para botones de exportaci√≥n */
        .botones-exportacion {
            margin: 2rem 0;
            text-align: center;
        }

        .btn-export {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-export.csv {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .btn-export.pdf {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .botones-exportacion {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-export {
                margin: 0;
            }
        }

        /* ESTILOS SIMPLES PARA CALENDARIO */
        #calendario .section h2 {
            text-align: center;
            color: #6e8efb;
            margin-bottom: 10px;
        }

        #calendario .section p {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        /* Controles del calendario */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .calendar-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #6e8efb;
        }

        .calendar-nav-btn {
            background: #6e8efb;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Grid del calendario */
        #calendario-emociones {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        /* D√≠as de la semana */
        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #6e8efb;
            color: white;
            border-radius: 5px;
        }

        /* D√≠as normales */
        .calendar-day {
            min-height: 60px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            text-align: center;
            background: white;
        }

        /* D√≠as con emociones */
        .calendar-day.has-emotion {
            border: 2px solid;
            font-weight: bold;
        }

        /* Colores b√°sicos para emociones */
        .emotion-feliz { border-color: #4CAF50; background: #E8F5E8; }
        .emotion-triste { border-color: #2196F3; background: #E3F2FD; }
        .emotion-enojado { border-color: #F44336; background: #FFEBEE; }
        .emotion-ansioso { border-color: #FF9800; background: #FFF3E0; }
        .emotion-calmado { border-color: #9C27B0; background: #F3E5F5; }
        .emotion-energico { border-color: #FFC107; background: #FFFDE7; }
        .emotion-confundido { border-color: #795548; background: #EFEBE9; }
        .emotion-agradecido { border-color: #009688; background: #E0F2F1; }

        /* === Pantalla de bienvenida === */
        .welcome-container {
          min-height: 100vh;
          display: flex;
          flex-direction: column;
          background: linear-gradient(180deg, #f7faff 0%, #edf3fb 100%);
          color: #333;
          font-family: 'Segoe UI', sans-serif;
        }

        /* Barra de navegaci√≥n superior */
        .welcome-nav {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 1rem 2rem;
          background-color: #4a6fa5;
          color: white;
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .nav-left {
          display: flex;
          align-items: center;
          gap: 0.5rem;
        }

        .logo-icon {
          font-size: 1.8rem;
        }

        .brand-name {
          font-weight: bold;
          font-size: 1.4rem;
          letter-spacing: 0.5px;
        }

        .nav-right {
          display: flex;
          gap: 1rem;
        }

        .nav-btn {
          background: transparent;
          border: none;
          color: white;
          font-size: 1rem;
          cursor: pointer;
          transition: color 0.3s ease, transform 0.2s ease;
        }

        .nav-btn:hover {
          color: #dfeaff;
          transform: scale(1.05);
        }

        .nav-btn.secondary {
          background-color: white;
          color: #4a6fa5;
          padding: 0.4rem 1rem;
          border-radius: 20px;
          font-weight: 600;
          transition: background-color 0.3s ease, color 0.3s ease;
        }

        .nav-btn.secondary:hover {
          background-color: #e6effb;
          color: #2e4f88;
        }

        /* Contenido principal */
        .welcome-main {
          text-align: center;
          padding: 3rem 2rem;
          max-width: 1000px;
          margin: 0 auto;
        }

        .welcome-main h1 {
          font-size: 2.5rem;
          color: #2e4f88;
          margin-bottom: 0.5rem;
        }

        .welcome-main h1 span {
          color: #4a6fa5;
        }

        .subtitle {
          font-size: 1.1rem;
          color: #5c6c7b;
          margin-bottom: 1.5rem;
        }

        .intro-text {
          color: #4b4b4b;
          font-size: 1rem;
          line-height: 1.6;
          margin-bottom: 2.5rem;
          max-width: 750px;
          margin-left: auto;
          margin-right: auto;
        }

        .welcome-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 1.5rem;
          margin-top: 1rem;
        }

        .welcome-cards .card {
          background: white;
          border-radius: 12px;
          padding: 1.5rem;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .welcome-cards .card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
        }

        .welcome-cards i {
          font-size: 2rem;
          color: #4a6fa5;
          margin-bottom: 0.7rem;
        }

        .final-text {
          margin-top: 3rem;
          color: #3c4e70;
          font-size: 1.1rem;
          font-weight: 500;
        }

        /* Oculta completamente cualquier secci√≥n */
        .hidden {
          display: none !important;
          visibility: hidden;
          opacity: 0;
        }

        /* Contenedor general */
        .welcome-main {
          text-align: center;
          background-color: #f6f8fc;
          padding-bottom: 3rem;
          font-family: 'Poppins', 'Segoe UI', sans-serif;
        }

        /* === Encabezado azul === */
        .welcome-header {
          background: linear-gradient(180deg, #3a5da9 0%, #4a6fa5 100%);
          color: #ffffff;
          padding: 3rem 2rem;
          border-radius: 0 0 40px 40px;
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .welcome-header h1 {
          font-size: 2.5rem;
          font-weight: 700;
          margin-bottom: 1rem;
          letter-spacing: 1px;
        }

        .welcome-header h1 span {
          color: #ffdd57; /* resalta el nombre */
        }

        .welcome-header .subtitle {
          font-size: 1.2rem;
          color: #f0f4ff;
          margin-bottom: 1rem;
        }

        .welcome-header .intro-text {
          max-width: 700px;
          margin: 0 auto;
          color: #e8edfc;
          line-height: 1.6;
        }

        /* Tarjetas debajo */
        .welcome-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 1.5rem;
          padding: 2.5rem 2rem;
          margin-top: 2rem;
        }

        .welcome-cards .card {
          background: white;
          border-radius: 14px;
          padding: 1.5rem;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .welcome-cards .card:hover {
          transform: translateY(-6px);
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .welcome-cards i {
          font-size: 2rem;
          color: #4a6fa5;
          margin-bottom: 0.7rem;
        }

        .final-text {
          color: #3c4e70;
          font-size: 1.1rem;
          font-weight: 500;
          margin-top: 2rem;
        }
        .welcome-main {
          text-align: center;
          background-color: #f6f8fc;
          font-family: 'Poppins', 'Segoe UI', sans-serif;
          padding-bottom: 3rem;
        }

        /* Fondo azul solo para el bloque superior */
        .welcome-header {
          background: linear-gradient(180deg, #3a5da9 0%, #4a6fa5 100%);
          color: #fff;
          padding: 4rem 2rem;
          border-radius: 0 0 40px 40px;
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .welcome-header h1 {
          font-size: 2.8rem;
          font-weight: 700;
          margin-bottom: 1rem;
        }

        .welcome-header h1 span {
          color: #ffdd57;
        }

        .welcome-header .subtitle {
          font-size: 1.2rem;
          color: #f0f4ff;
          margin-bottom: 1rem;
        }

        .welcome-header .intro-text {
          max-width: 700px;
          margin: 0 auto;
          color: #e8edfc;
          line-height: 1.7;
        }

        /* Tarjetas y resto permanecen igual */
        .welcome-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 1.5rem;
          padding: 2.5rem 2rem;
          margin-top: 2rem;
        }

        .hidden {
          display: none !important;
          visibility: hidden;
          opacity: 0;
        }

        /* === Contenedor principal de bienvenida === */
        .welcome-header {
          background: linear-gradient(180deg, #365f9c 0%, #27497b 100%); /* Azul oscuro elegante */
          padding: 60px 40px;
          border-radius: 35px; /* Bordes suaves */
          text-align: center;
          color: white;
          width: 90%;
          max-width: 1000px;
          margin: 60px auto;
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); /* Sombra m√°s sutil */
        }

        /* === Texto principal === */
        .welcome-header h1 {
          font-size: 2.5rem;
          font-weight: 800;
          color: #dfe7f5;
          margin-bottom: 10px;
        }

        .welcome-header span {
          color: #f8d23b; /* Amarillo c√°lido para resaltar 'Mente Sana' */
        }

        .subtitle {
          font-size: 1.2rem;
          margin-bottom: 20px;
          color: #e6ebf5;
        }

        .intro-text {
          font-size: 1rem;
          color: #cfd8e5;
          line-height: 1.7;
          max-width: 750px;
          margin: 0 auto;
        }

        /* === √çcono del cerebro al lado del texto === */
        .moving-brain {
          font-size: 40px; /* üîπ Tama√±o mediano */
          color: #b0d0e7; /* Verde original */
          margin-left: 10px; /* Espacio entre el texto y el √≠cono */
          vertical-align: middle; /* Alineado con el texto */
          transition: transform 0.3s ease;
          cursor: pointer;
        }

        /* Efecto de movimiento suave al pasar el mouse */
        .moving-brain:hover {
          transform: rotate(10deg) scale(1.2);
        }

        /* ===== ESTILOS MEJORADOS PARA LA MASCOTA CON IM√ÅGENES/VIDEOS ===== */

        .pet-container {
            text-align: center;
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .pet-display {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
            box-shadow: var(--shadow);
            border: 3px solid var(--primary-light);
            transition: var(--transition);
        }

        .pet-display:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .pet-image, .pet-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pet-status {
            font-size: 1.2rem;
            color: var(--primary-dark);
            background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
            padding: 1rem 1.5rem;
            border-radius: 50px;
            display: inline-block;
            border: 2px solid var(--primary-light);
            box-shadow: var(--shadow);
            min-width: 300px;
            transition: var(--transition);
        }

        .pet-status:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .pet-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            width: 100%;
            max-width: 800px;
        }

        .pet-stat {
            background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
            padding: 1.2rem;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--light-gray);
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .pet-stat:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .pet-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .pet-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.3rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pet-stat-label {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Barra de progreso */
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--light-gray);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.8rem;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        /* Selector de mascotas */
        .pet-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .pet-option {
            cursor: pointer;
            padding: 1.2rem 1.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
            background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.7rem;
            min-width: 120px;
            border: 2px solid transparent;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .pet-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .pet-option:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .pet-option:hover::before {
            transform: scaleX(1);
        }

        .pet-option:hover .pet-icon {
            transform: scale(1.2);
        }

        .pet-option.selected {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 111, 165, 0.3);
        }

        .pet-option.selected::before {
            transform: scaleX(1);
            background: var(--accent);
        }

        .pet-icon {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            transition: var(--transition);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        /* Selector de comida */
        .food-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            width: 100%;
            max-width: 800px;
        }

        .food-option {
            cursor: pointer;
            padding: 1.2rem;
            border-radius: var(--radius);
            transition: var(--transition);
            background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.7rem;
            border: 2px solid transparent;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .food-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--success);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .food-option:hover {
            background: linear-gradient(135deg, var(--success) 0%, #51CF66 100%);
            color: white;
            transform: translateY(-5px) scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .food-option:hover::before {
            transform: scaleX(1);
        }

        .food-option:hover .food-icon {
            transform: scale(1.3) rotate(10deg);
        }

        .food-icon {
            font-size: 2.5rem;
            transition: var(--transition);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .food-option small {
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .food-option:hover small {
            opacity: 1;
        }

        /* Acciones de la mascota */
        .pet-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            width: 100%;
            max-width: 800px;
        }

        .pet-actions .btn {
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pet-actions .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .pet-actions .btn:hover::before {
            left: 100%;
        }

        .pet-actions .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* Estados especiales */
        .pet-hungry {
            animation: pulse 1.5s ease-in-out infinite !important;
        }

        .pet-tired {
            animation: slide 3s ease-in-out infinite !important;
            opacity: 0.7;
        }

        .pet-happy {
            animation: jump 1s ease-in-out infinite !important;
        }

        .pet-playing {
            animation: play 0.8s ease-in-out infinite !important;
        }

        .pet-eating {
            animation: eat 0.6s ease-in-out !important;
        }

        /* Animaciones */
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1; 
            }
            50% { 
                transform: scale(1.15); 
                opacity: 0.8; 
            }
        }

        @keyframes slide {
            0%, 100% { 
                transform: translateX(0); 
            }
            25% { 
                transform: translateX(8px); 
            }
            75% { 
                transform: translateX(-8px); 
            }
        }

        @keyframes jump {
            0%, 100% { 
                transform: translateY(0) scale(1); 
            }
            50% { 
                transform: translateY(-25px) scale(1.2); 
            }
        }

        @keyframes play {
            0% { 
                transform: translateX(0) rotate(0deg); 
            }
            25% { 
                transform: translateX(20px) rotate(15deg); 
            }
            50% { 
                transform: translateX(-15px) rotate(-10deg); 
            }
            75% { 
                transform: translateX(10px) rotate(8deg); 
            }
            100% { 
                transform: translateX(0) rotate(0deg); 
            }
        }

        @keyframes eat {
            0% { 
                transform: scale(1) rotate(0deg); 
            }
            25% { 
                transform: scale(1.3) rotate(15deg); 
            }
            50% { 
                transform: scale(1.1) rotate(-10deg); 
            }
            75% { 
                transform: scale(1.25) rotate(8deg); 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .pet-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }
            
            .pet-stat {
                padding: 1rem;
            }
            
            .pet-stat-value {
                font-size: 1.5rem;
            }
            
            .pet-option {
                min-width: 100px;
                padding: 1rem;
            }
            
            .pet-icon {
                width: 50px;
                height: 50px;
            }
            
            .food-selector {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }
            
            .food-option {
                padding: 1rem;
            }
            
            .food-icon {
                font-size: 2rem;
            }
            
            .pet-actions {
                grid-template-columns: 1fr;
            }
            
            .pet-status {
                min-width: auto;
                font-size: 1rem;
                padding: 0.8rem 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .pet-stats {
                grid-template-columns: 1fr;
            }
            
            .pet-selector {
                gap: 0.5rem;
            }
            
            .pet-option {
                min-width: 80px;
                padding: 0.8rem;
            }
            
            .food-selector {
                grid-template-columns: 1fr;
            }
        }
        /* Placeholder cuando no hay mascota seleccionada */
        .placeholder-mascota {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-light);
        }

        /* Estados de la mascota */
        .pet-display.descansando {
            opacity: 0.7;
            filter: brightness(0.8);
        }

        .pet-display.jugando {
            animation: bounce 0.5s ease-in-out infinite;
        }

        .pet-display.feliz {
            animation: pulse 1s ease-in-out infinite;
        }

        .pet-display.comiendo {
            animation: nomnom 0.6s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes nomnom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }


        .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin: 20px 0;
    background: white;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #ddd;
}

.calendar-header {
    text-align: center;
    font-weight: bold;
    padding: 10px;
    background: var(--primary);
    color: white;
    border-radius: 5px;
}

.calendar-day {
    min-height: 80px;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 8px;
    text-align: center;
    background: white;
    position: relative;
    transition: all 0.3s ease;
}

.calendar-day:hover {
    background: #f8f9fa;
    transform: translateY(-2px);
}

.calendar-day.has-emotion {
    border: 2px solid;
    font-weight: bold;
}

/* ===== ESTRUCTURA MEJORADA MASCOTA ===== */

/* Contenedor de selecci√≥n */
.mascota-seleccion-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 2rem;
    border-radius: var(--radius);
    margin-bottom: 2rem;
    border: 2px dashed var(--primary-light);
}

.mascota-seleccion-container h3 {
    text-align: center;
    color: var(--primary-dark);
    margin-bottom: 1.5rem;
    font-size: 1.4rem;
}

/* Grid de selecci√≥n de mascotas */
.pet-selector-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.pet-option-card {
    background: white;
    border-radius: var(--radius);
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid transparent;
    box-shadow: var(--shadow);
}

.pet-option-card:hover {
    transform: translateY(-5px);
    border-color: var(--primary);
    box-shadow: var(--shadow-hover);
}

.pet-option-card.selected {
    border-color: var(--primary);
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
}

.pet-option-image {
    margin-bottom: 1rem;
}

.pet-icon-large {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid var(--primary-light);
}

.pet-option-info h4 {
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
    color: var(--primary-dark);
}

.pet-option-card.selected h4 {
    color: white;
}

.pet-option-info p {
    color: var(--text-light);
    margin-bottom: 1rem;
}

.pet-option-card.selected p {
    color: rgba(255,255,255,0.9);
}

.pet-traits {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.trait {
    background: var(--light);
    padding: 0.3rem 0.7rem;
    border-radius: 20px;
    font-size: 0.8rem;
    color: var(--text);
}

.pet-option-card.selected .trait {
    background: rgba(255,255,255,0.2);
    color: white;
}

/* Contenedor mascota activa */
.mascota-activa-container {
    background: white;
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow);
}

.mascota-header {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 2rem;
    margin-bottom: 2rem;
}

.mascota-display-section {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.pet-display-large {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
    box-shadow: var(--shadow);
    border: 4px solid var(--primary-light);
    position: relative;
    flex-shrink: 0;
}

.mascota-info {
    flex: 1;
}

.pet-status-large {
    background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary-light) 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: var(--radius);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    text-align: center;
    box-shadow: var(--shadow);
}

.mascota-nivel-info {
    background: var(--light);
    padding: 1.5rem;
    border-radius: var(--radius);
}

.nivel-badge {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.nivel-label {
    font-weight: 600;
    color: var(--text);
}

.nivel-value {
    background: var(--primary);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
    font-size: 1.2rem;
}

.exp-bar-container {
    margin-top: 1rem;
}

.exp-label {
    font-size: 0.9rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.progress-bar-large {
    height: 20px;
    background: var(--light-gray);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.progress-fill-large {
    height: 100%;
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    border-radius: 10px;
    transition: width 0.5s ease;
    position: relative;
}

.exp-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text);
    text-shadow: 0 1px 2px rgba(255,255,255,0.8);
}

/* Estad√≠sticas r√°pidas */
.estadisticas-rapidas {
    background: var(--light);
    padding: 1.5rem;
    border-radius: var(--radius);
}

.estadisticas-rapidas h4 {
    margin-bottom: 1rem;
    color: var(--primary-dark);
    text-align: center;
}

.stats-grid-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.8rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--light);
    border-radius: 50%;
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--primary);
}

.stat-label {
    font-size: 0.8rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Interacciones */
.interacciones-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 2rem;
    margin-top: 2rem;
}

.interaccion-columna h4 {
    margin-bottom: 1rem;
    color: var(--primary-dark);
    text-align: center;
}

/* Comida */
.food-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.8rem;
}

.food-card {
    background: white;
    padding: 1rem;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    text-align: center;
    box-shadow: var(--shadow);
}

.food-card:hover {
    transform: translateY(-3px);
    border-color: var(--success);
    box-shadow: var(--shadow-hover);
}

.food-icon-large {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.food-name {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.3rem;
}

.food-cost {
    font-size: 0.8rem;
    color: var(--text-light);
}

/* Juegos */
.games-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.8rem;
}

.game-btn {
    background: white;
    border: 2px solid var(--light-gray);
    padding: 1rem;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.game-btn:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.game-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.game-text {
    font-weight: 600;
    color: var(--text);
    font-size: 0.9rem;
}

/* Cuidados */
.care-actions {
    display: grid;
    gap: 0.8rem;
    margin-bottom: 1.5rem;
}

.care-btn {
    padding: 1rem;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.mascota-tips {
    background: var(--light);
    padding: 1rem;
    border-radius: var(--radius);
}

.mascota-tips h5 {
    margin-bottom: 0.8rem;
    color: var(--primary);
}

.mascota-tips ul {
    list-style: none;
    padding: 0;
}

.mascota-tips li {
    padding: 0.3rem 0;
    color: var(--text);
    font-size: 0.9rem;
    position: relative;
    padding-left: 1.2rem;
}

.mascota-tips li:before {
    content: "‚Ä¢";
    color: var(--primary);
    position: absolute;
    left: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .mascota-header {
        grid-template-columns: 1fr;
    }
    
    .mascota-display-section {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .interacciones-container {
        grid-template-columns: 1fr;
    }
    
    .pet-selector-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid-compact {
        grid-template-columns: 1fr;
    }
}
/* Colores para emociones */
.emotion-feliz { border-color: #4CAF50; background: #E8F5E8; }
.emotion-triste { border-color: #2196F3; background: #E3F2FD; }
.emotion-enojado { border-color: #F44336; background: #FFEBEE; }
.emotion-ansioso { border-color: #FF9800; background: #FFF3E0; }
.emotion-calmado { border-color: #9C27B0; background: #F3E5F5; }
.emotion-energico { border-color: #FFC107; background: #FFFDE7; }
.emotion-confundido { border-color: #795548; background: #EFEBE9; }
.emotion-agradecido { border-color: #009688; background: #E0F2F1; }

.calendar-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.calendar-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--primary);
}

.calendar-nav-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.calendar-nav-btn:hover {
    background: var(--primary-dark);
}

/* ============================================= */
/* ESTILOS PARA EL CALENDARIO EMOCIONAL */
/* ============================================= */

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin: 20px 0;
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.calendar-header {
    text-align: center;
    font-weight: bold;
    padding: 12px 8px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border-radius: 8px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.calendar-day {
    min-height: 100px;
    border: 2px solid #f0f0f0;
    border-radius: 10px;
    padding: 10px;
    text-align: center;
    background: white;
    position: relative;
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.calendar-day:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-color: var(--primary-light);
}

.calendar-day.empty {
    background: #f8f9fa;
    border: 2px dashed #e0e0e0;
    cursor: default;
}

.calendar-day.empty:hover {
    transform: none;
    box-shadow: none;
    border-color: #e0e0e0;
}

.calendar-day-number {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
}

.calendar-day.today .calendar-day-number {
    color: var(--accent);
    font-weight: 800;
}

.calendar-day.today {
    border-color: var(--accent);
    background: linear-gradient(135deg, #fff 0%, #fff8f8 100%);
}

/* Estilos para d√≠as con emociones */
.calendar-day.has-emotion {
    border-width: 3px;
    font-weight: 600;
}

.emotion-icon {
    font-size: 1.8rem;
    margin-top: 5px;
}

.emotion-counter {
    position: absolute;
    top: 5px;
    right: 5px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

/* Colores para cada emoci√≥n */
.emotion-feliz { 
    border-color: #4CAF50 !important; 
    background: linear-gradient(135deg, #E8F5E8 0%, #f8fff8 100%) !important;
}
.emotion-triste { 
    border-color: #2196F3 !important; 
    background: linear-gradient(135deg, #E3F2FD 0%, #f8fbff 100%) !important;
}
.emotion-enojado { 
    border-color: #F44336 !important; 
    background: linear-gradient(135deg, #FFEBEE 0%, #fff8f8 100%) !important;
}
.emotion-ansioso { 
    border-color: #FF9800 !important; 
    background: linear-gradient(135deg, #FFF3E0 0%, #fffcf8 100%) !important;
}
.emotion-calmado { 
    border-color: #9C27B0 !important; 
    background: linear-gradient(135deg, #F3E5F5 0%, #fef8ff 100%) !important;
}
.emotion-energico { 
    border-color: #FFC107 !important; 
    background: linear-gradient(135deg, #FFFDE7 0%, #fffff8 100%) !important;
}
.emotion-confundido { 
    border-color: #795548 !important; 
    background: linear-gradient(135deg, #EFEBE9 0%, #faf8f8 100%) !important;
}
.emotion-agradecido { 
    border-color: #009688 !important; 
    background: linear-gradient(135deg, #E0F2F1 0%, #f8fffe 100%) !important;
}

/* Controles del calendario */
.calendar-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.calendar-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary-dark);
    text-align: center;
    flex: 1;
}

.calendar-nav-btn {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.calendar-nav-btn:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 111, 165, 0.3);
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

.modal-container {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

/* Estilos para la lista de emociones en el modal */
.emociones-lista {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.emocion-item {
    background: white;
    padding: 1.2rem;
    border-radius: 8px;
    border-left: 4px solid;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.emocion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
}

.emocion-tipo {
    font-weight: 700;
    font-size: 1.1rem;
    text-transform: capitalize;
}

.emocion-hora {
    color: #6c757d;
    font-size: 0.9rem;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
}

.emocion-notas {
    color: #495057;
    line-height: 1.5;
    background: #f8f9fa;
    padding: 0.8rem;
    border-radius: 6px;
    border-left: 3px solid #dee2e6;
}

.sin-notas {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 0.5rem;
}

/* ============================================= */
/* ESTILOS PARA CENTRAR PANTALLAS DE AUTENTICACI√ìN */
/* ============================================= */

.auth-screen-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
    padding: 20px;
}

.auth-container {
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    padding: 2rem;
    background-color: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--light-gray);
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.auth-form h2 {
    text-align: center;
    margin-bottom: 1rem;
    color: var(--primary);
    font-size: 1.8rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 600;
    color: var(--primary-dark);
    font-size: 0.95rem;
}

.form-group input {
    padding: 0.75rem 1rem;
    border: 2px solid var(--light-gray);
    border-radius: var(--radius);
    font-size: 1rem;
    transition: var(--transition);
    background: #fafbfc;
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
}

.auth-toggle {
    text-align: center;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--light-gray);
}

.auth-toggle a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition);
}

.auth-toggle a:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

/* Estilos espec√≠ficos para botones de auth */
.auth-btn {
    width: 100%;
    padding: 0.875rem;
    font-size: 1rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

/* Animaci√≥n de entrada */
@keyframes slideUpFade {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.auth-container {
    animation: slideUpFade 0.5s ease-out;
}

/* Estilos BASE (para m√≥viles) */
body {
  font-size: 16px;
  line-height: 1.5;
}
.container {
  width: 100%;
  padding: 10px;
}
.menu {
  display: block;
}

/* Estilos para TABLETS (pantallas de 768px en adelante) */
@media (min-width: 768px) {
  .container {
    width: 750px;
    margin: 0 auto; /* Centra el contenedor */
  }
  .menu {
    display: flex;
  }
}

/* Estilos para ESCRITORIO (pantallas de 1024px en adelante) */
@media (min-width: 1024px) {
  .container {
    width: 980px;
  }
  body {
    font-size: 18px;
  }
}
.nav {
  display: flex;
  flex-direction: column; /* En m√≥vil, los items se apilan en columna */
}

@media (min-width: 768px) {
  .nav {
    flex-direction: row; /* En tablet/desktop, se ponen en fila */
  }
}
/* ===== ESTILOS MEJORADOS PARA LA MASCOTA ===== */
.pet-container {
    text-align: center;
    margin: 2rem 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.pet-display {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
    box-shadow: var(--shadow);
    border: 3px solid var(--primary-light);
    transition: var(--transition);
    position: relative;
}

.pet-display:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-hover);
}

/* üî• CONTENEDOR DE MEDIA MEJORADO */
#pet-media-container {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

/* üî• ESTILOS GENERALES PARA VIDEOS */
.pet-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.pet-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* üî• SOLUCI√ìN NUCLEAR PARA AXOLOTE */
#pet-media-container video[src*="axolote"] {
    width: 250% !important;
    height: 250% !important;
    object-fit: cover !important;
    object-position: center 45% !important;
    border-radius: 50% !important;
    position: absolute !important;
    top: -60% !important;
    left: -60% !important;
    transform: scale(1.6) !important;
    z-index: 2;
}

/* üî• VERSI√ìN M√ÅS AGRESIVA POR SI ACASO */
.pet-display[data-pet="axolote"] video {
    width: 280% !important;
    height: 280% !important;
    object-fit: cover !important;
    object-position: center 50% !important;
    border-radius: 50% !important;
    position: absolute !important;
    top: -70% !important;
    left: -70% !important;
    transform: scale(1.8) !important;
    z-index: 2;
}

.placeholder-mascota {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-light);
    z-index: 1;
}

.pet-status {
    font-size: 1.2rem;
    color: var(--primary-dark);
    background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
    padding: 1rem 1.5rem;
    border-radius: 50px;
    display: inline-block;
    border: 2px solid var(--primary-light);
    box-shadow: var(--shadow);
    min-width: 300px;
    transition: var(--transition);
}

/* ============================================= */
/* CALENDARIO RESPONSIVE PARA M√ìVIL */
/* ============================================= */

@media (max-width: 768px) {
    /* Contenedor principal del calendario */
    #calendario-emociones {
        grid-template-columns: repeat(7, 1fr) !important;
        gap: 3px !important;
        padding: 8px !important;
        margin: 10px 0 !important;
        font-size: 12px;
    }
    
    /* D√≠as de la semana */
    .calendar-header {
        padding: 8px 2px !important;
        font-size: 0.7rem !important;
        font-weight: 600;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    
    /* D√≠as del mes */
    .calendar-day {
        min-height: 45px !important;
        padding: 4px !important;
        border-width: 1px !important;
        border-radius: 6px !important;
    }
    
    .calendar-day-number {
        font-size: 0.8rem !important;
        font-weight: 600;
        margin-bottom: 1px !important;
    }
    
    .emotion-icon {
        font-size: 1rem !important;
        margin-top: 1px !important;
    }
    
    /* Controles del calendario */
    .calendar-controls {
        flex-direction: column !important;
        gap: 8px !important;
        padding: 12px !important;
        margin-bottom: 15px !important;
    }
    
    .calendar-title {
        font-size: 1rem !important;
        order: -1;
        text-align: center;
    }
    
    .calendar-nav-btn {
        padding: 8px 12px !important;
        font-size: 0.8rem !important;
        width: 100%;
        text-align: center;
    }
    
    /* Ajustar secci√≥n completa */
    #calendario.section {
        padding: 1rem !important;
    }
    
    #calendario h2 {
        font-size: 1.4rem !important;
        margin-bottom: 1rem !important;
    }
    
    #calendario p {
        font-size: 0.9rem !important;
    }
}

/* Para pantallas muy peque√±as */
@media (max-width: 480px) {
    #calendario-emociones {
        gap: 2px !important;
        padding: 5px !important;
    }
    
    .calendar-day {
        min-height: 40px !important;
        padding: 2px !important;
    }
    
    .calendar-day-number {
        font-size: 0.75rem !important;
    }
    
    .emotion-icon {
        font-size: 0.9rem !important;
    }
    
    .calendar-header {
        font-size: 0.65rem !important;
        padding: 6px 1px !important;
        min-height: 25px;
    }
    
    .emotion-counter {
        width: 14px !important;
        height: 14px !important;
        font-size: 0.5rem !important;
        top: 1px !important;
        right: 1px !important;
    }
    
    /* Hacer que los d√≠as ocupen espacio uniforme */
    .calendar-day {
        aspect-ratio: 1 / 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
}

/* Mejoras de UX para m√≥vil */
.calendar-day {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    cursor: pointer;
}

.calendar-day:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
}

/* Asegurar que el grid mantenga proporciones */
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    width: 100%;
}

/* Prevenir desbordamiento en m√≥vil */
.container {
    overflow-x: hidden;
}

.section {
    overflow-x: hidden;
}

/* ===== ESTILOS MEJORADOS PARA GIFs ===== */
.pet-gif-playing {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    object-position: center center !important;
    border-radius: 50% !important;
    display: block !important;
}

/* Animaciones durante el juego */
.pet-display.jugando-activo {
    animation: jumpPlay 0.6s ease-in-out infinite !important;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5) !important;
}

@keyframes jumpPlay {
    0%, 100% { 
        transform: translateY(0) scale(1.05); 
    }
    50% { 
        transform: translateY(-15px) scale(1.1); 
    }
}

/* Efecto de brillo */
.pet-display.jugando-activo::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
    z-index: 1;
    animation: pulseGlow 1s ease-in-out infinite alternate;
}

@keyframes pulseGlow {
    from { 
        opacity: 0.4; 
        transform: scale(1);
    }
    to { 
        opacity: 0.8; 
        transform: scale(1.1);
    }
}

/* Mensaje de estado especial durante juego */
.pet-status:contains("jugando") {
    background: linear-gradient(135deg, #FFD700, #FFA500) !important;
    color: white !important;
    animation: textPulse 0.8s ease-in-out infinite alternate;
}

@keyframes textPulse {
    from { transform: scale(1); }
    to { transform: scale(1.05); }
}

/* Estilos para el modal de emociones */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

.modal-container {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

/* Estilos para la lista de emociones en el modal */
.emociones-lista {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.emocion-item {
    background: white;
    padding: 1.2rem;
    border-radius: 8px;
    border-left: 4px solid;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.emocion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
}

.emocion-tipo {
    font-weight: 700;
    font-size: 1.1rem;
    text-transform: capitalize;
}

.emocion-hora {
    color: #6c757d;
    font-size: 0.9rem;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
}

.emocion-notas {
    color: #495057;
    line-height: 1.5;
    background: #f8f9fa;
    padding: 0.8rem;
    border-radius: 6px;
    border-left: 3px solid #dee2e6;
}

.sin-notas {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 0.5rem;
}

/* Colores para cada tipo de emoci√≥n en el modal */
.emocion-item.emotion-feliz { border-left-color: #4CAF50; }
.emocion-item.emotion-triste { border-left-color: #2196F3; }
.emocion-item.emotion-enojado { border-left-color: #F44336; }
.emocion-item.emotion-ansioso { border-left-color: #FF9800; }
.emocion-item.emotion-calmado { border-left-color: #9C27B0; }
.emocion-item.emotion-energico { border-left-color: #FFC107; }
.emocion-item.emotion-confundido { border-left-color: #795548; }
.emocion-item.emotion-agradecido { border-left-color: #009688; }

stat-card {
    background: linear-gradient(135deg, #bccadd 0%, var(--primary-light) 100%);
    color: white;
    border-radius: var(--radius);
    padding: 1.5rem;
    text-align: center;
    box-shadow: var(--shadow);
}
.stat-value {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(135deg, #86a8d8 0%, var(--primary) 100%);
}

/* CONTENEDOR PRINCIPAL DE SELECCI√ìN */
.mascota-seleccion-container {
    background: white;
    border-radius: 20px;
    padding: 25px;
    margin: 20px 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 2px solid #e3f2fd;
}

.mascota-seleccion-container h3 {
    text-align: center;
    color: #333;
    margin-bottom: 25px;
    font-size: 1.4rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* GRID DE SELECCI√ìN */
.pet-selector-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

/* TARJETAS DE MASCOTAS */
.pet-option-card {
    background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid transparent;
    position: relative;
    overflow: hidden;
}

.pet-option-card:hover {
    transform: translateY(-5px);
    border-color: #667eea;
    box-shadow: 0 15px 30px rgba(102, 126, 234, 0.2);
}

.pet-option-card.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.pet-option-card.selected h4,
.pet-option-card.selected p {
    color: white;
}

/* IM√ÅGENES DE MASCOTAS */
.pet-option-image {
    width: 120px;
    height: 120px;
    margin: 0 auto 15px;
    border-radius: 50%;
    background: linear-gradient(135deg, #a8edea, #fed6e3);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 4px solid white;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.pet-icon-large {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    transition: transform 0.3s ease;
}

.pet-option-card:hover .pet-icon-large {
    transform: scale(1.1);
}

/* INFORMACI√ìN DE MASCOTAS */
.pet-option-info h4 {
    font-size: 1.3rem;
    margin-bottom: 8px;
    color: #333;
    font-weight: bold;
}

.pet-option-info p {
    color: #666;
    margin-bottom: 15px;
    font-size: 0.95rem;
}

/* RASGOS DE MASCOTAS */
.pet-traits {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}

.trait {
    background: rgba(102, 126, 234, 0.1);
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #667eea;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.pet-option-card.selected .trait {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border-color: rgba(255, 255, 255, 0.3);
}

/* ESTADOS DE LAS TARJETAS */
.pet-option-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s ease;
}

.pet-option-card:hover::before {
    left: 100%;
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .pet-selector-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .pet-option-card {
        padding: 15px;
    }
    
    .pet-option-image {
        width: 100px;
        height: 100px;
    }
}

/* FALLBACK PARA IM√ÅGENES QUE NO CARGAN */
.pet-option-image:has(img[src=""])::after,
.pet-option-image:not(:has(img[src]))::after {
    content: 'üêæ';
    font-size: 3rem;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* MEJORAS VISUALES */
.pet-option-card {
    position: relative;
}

.pet-option-card::after {
    content: 'üëâ Haz clic para seleccionar';
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    background: #667eea;
    color: white;
    padding: 5px 10px;
    border-radius: 10px;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.3s ease, bottom 0.3s ease;
    white-space: nowrap;
}

.pet-option-card:hover::after {
    opacity: 1;
    bottom: -25px;
}

.pet-option-card.selected::after {
    content: '‚úÖ Seleccionada';
    background: #4CAF50;
}

/* Estilos para la mascota activa */
.mascota-visual {
    text-align: center;
    padding: 1rem;
}

.mascota-imagen-activa {
    max-width: 200px;
    max-height: 200px;
    border-radius: 10px;
    margin-bottom: 1rem;
}

/* Estilos para manejar errores de imagen */
.pet-option-image img {
    max-width: 100px;
    max-height: 100px;
    object-fit: contain;
}

/* Estilos responsivos */
@media (max-width: 768px) {
    .mascota-header {
        flex-direction: column;
    }
    
    .interacciones-container {
        flex-direction: column;
    }
}


    </style>
</head>
<body>
    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="welcome-container">
        <!-- Barra superior -->
        <nav class="welcome-nav">
            <div class="nav-left">
                <i class="fas fa-brain big-logo"></i>
                <span class="brand-name">Mente Sana</span>
            </div>
            <div class="nav-right">
                <button onclick="mostrarPantalla('welcome-screen')" class="nav-btn">Inicio</button>
                <button onclick="mostrarPantalla('login-screen')" class="nav-btn">Iniciar Sesi√≥n</button>
                <button onclick="mostrarPantalla('register-screen')" class="nav-btn secondary">Registrarse</button>
            </div>
        </nav>

        <!-- Secci√≥n principal -->
        <section class="welcome-main">
            <!-- Fondo azul -->
            <div class="welcome-header">
                <!-- üîπ √çcono del cerebro junto al texto -->
                <i class="fas fa-brain moving-brain"></i>
                <h1>Bienvenido a <span>Mente Sana</span></h1>
                <p class="subtitle">
                    Tu espacio para el bienestar mental y emocional.  
                    Encuentra calma, equilibrio y motivaci√≥n cada d√≠a.
                </p>

                <p class="intro-text">
                    En <strong>Mente Sana</strong> encontrar√°s herramientas, recursos y una comunidad que te acompa√±ar√° en tu
                    camino hacia una mejor salud mental. Registra tus emociones, sigue tu progreso, practica ejercicios de
                    atenci√≥n plena y cuida tu bienestar.
                </p>
            </div>

            <div class="welcome-cards">
                <div class="card">
                    <i class="fas fa-book"></i>
                    <h3>Diario Emocional</h3>
                    <p>Registra y comprende tus emociones diarias.</p>
                </div>
                <div class="card">
                    <i class="fas fa-chart-line"></i>
                    <h3>Seguimiento</h3>
                    <p>Visualiza tus progresos y tendencias emocionales.</p>
                </div>
                <div class="card">
                    <i class="fas fa-spa"></i>
                    <h3>Mindfulness</h3>
                    <p>Practica ejercicios de relajaci√≥n y bienestar mental.</p>
                </div>
                <div class="card">
                    <i class="fas fa-paw"></i>
                    <h3>Mascota Virtual</h3>
                    <p>Cuida a tu compa√±ero digital y mejora tu estado de √°nimo.</p>
                </div>
            </div>

            <p class="final-text">
                üå± Cuida tu mente, fortalece tus emociones y redescubre tu bienestar interior.
            </p>
        </section>
    </div> <!-- üîπ AQU√ç CERRAMOS welcome-screen -->

  <!-- Pantalla de Inicio de Sesi√≥n CENTRADA -->
<div id="login-screen" class="auth-screen-container hidden">
    <div class="auth-container">
        <div class="auth-form">
            <h2><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</h2>
            <div class="form-group">
                <label for="login-email">Correo electr√≥nico</label>
                <input type="email" id="login-email" placeholder="tu@email.com">
            </div>
            <div class="form-group">
                <label for="login-password">Contrase√±a</label>
                <input type="password" id="login-password" placeholder="Tu contrase√±a">
            </div>
            <button class="btn auth-btn" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
            </button>
            <div class="auth-toggle">
                <p>¬øNo tienes una cuenta? <a href="#" onclick="mostrarPantalla('register-screen')">Reg√≠strate aqu√≠</a></p>
            </div>
        </div>
    </div>
</div>

<!-- Pantalla de Registro CENTRADA -->
<div id="register-screen" class="auth-screen-container hidden">
    <div class="auth-container">
        <div class="auth-form">
            <h2><i class="fas fa-user-plus"></i> Crear Cuenta</h2>
            <div class="form-group">
                <label for="register-name">Nombre completo</label>
                <input type="text" id="register-name" placeholder="Tu nombre completo">
            </div>
            <div class="form-group">
                <label for="register-email">Correo electr√≥nico</label>
                <input type="email" id="register-email" placeholder="tu@email.com">
            </div>
            <div class="form-group">
                <label for="register-password">Contrase√±a</label>
                <input type="password" id="register-password" placeholder="Crea una contrase√±a segura">
            </div>
            <div class="form-group">
                <label for="register-confirm">Confirmar contrase√±a</label>
                <input type="password" id="register-confirm" placeholder="Repite tu contrase√±a">
            </div>
            <button class="btn auth-btn" onclick="register()">
                <i class="fas fa-user-plus"></i> Crear Cuenta
            </button>
            <div class="auth-toggle">
                <p>¬øYa tienes una cuenta? <a href="#" onclick="mostrarPantalla('login-screen')">Inicia sesi√≥n aqu√≠</a></p>
            </div>
        </div>
    </div>
</div>

    <!-- Funcionalidades de la pagina web desarrolladas -->
    <div id="main-app" class="hidden">
        <header>
            <div class="header-content">
                <div>
                    <h1><i class="fas fa-brain"></i> Mente Sana</h1>
                    <p class="tagline">Tu espacio para el bienestar mental</p>
                </div>
                <div class="user-info">
                    <span class="welcome-message" id="welcome-message">¬°Bienvenido!</span>
                    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
                    <button class="logout-btn" onclick="showSection('perfil')"><i class="fas fa-user"></i> Perfil</button>
                </div>
            </div>
        </header>
        
        <nav>
            <div class="nav-container">
                <div class="nav-links">
                    <button class="active" onclick="showSection('diario')"><i class="fas fa-book"></i> Diario</button>
                    <button onclick="showSection('seguimiento')"><i class="fas fa-chart-line"></i> Seguimiento</button>
                    <button onclick="showSection('ejercicios')"><i class="fas fa-spa"></i> Ejercicios</button>
                    <button onclick="showSection('retos')"><i class="fas fa-bullseye"></i> Retos</button>
                    <button onclick="showSection('calendario')"><i class="fas fa-calendar-alt"></i> Calendario</button>
                    <button onclick="showSection('mascota')"><i class="fas fa-paw"></i> Mascota</button>
                    <button onclick="showSection('recursos')"><i class="fas fa-info-circle"></i> Recursos</button>
                </div>
            </div>
        </nav>
        
        <div class="container">
            <!-- Diario Emocional -->
            <section id="diario" class="section active">
                <h2><i class="fas fa-book"></i> Diario Emocional</h2>
                <p>Registra c√≥mo te sientes hoy. Selecciona una emoci√≥n y a√±ade notas si lo deseas.</p>
                
                <div class="emotion-grid">
                    <div class="emotion" data-emotion="feliz">
                        <div class="emotion-icon">üòä</div>
                        <div>Feliz</div>
                    </div>
                    <div class="emotion" data-emotion="triste">
                        <div class="emotion-icon">üò¢</div>
                        <div>Triste</div>
                    </div>
                    <div class="emotion" data-emotion="enojado">
                        <div class="emotion-icon">üò†</div>
                        <div>Enojado</div>
                    </div>
                    <div class="emotion" data-emotion="ansioso">
                        <div class="emotion-icon">üò∞</div>
                        <div>Ansioso</div>
                    </div>
                    <div class="emotion" data-emotion="calmado">
                        <div class="emotion-icon">üòå</div>
                        <div>Calmado</div>
                    </div>
                    <div class="emotion" data-emotion="energico">
                        <div class="emotion-icon">üòÑ</div>
                        <div>Energ√©tico</div>
                    </div>
                    <div class="emotion" data-emotion="confundido">
                        <div class="emotion-icon">üòï</div>
                        <div>Confundido</div>
                    </div>
                    <div class="emotion" data-emotion="agradecido">
                        <div class="emotion-icon">üôè</div>
                        <div>Agradecido</div>
                    </div>
                </div>
                
                <label for="notas"><strong>Notas adicionales:</strong></label>
             <textarea id="notas-emocion" placeholder="Describe c√≥mo te sientes o qu√© ha influido en tu estado de √°nimo..."></textarea>

              <button class="btn" onclick="guardarEmocion(getEmocionSeleccionada())">
              <i class="fas fa-save"></i> Guardar emoci√≥n
             </button>

                <button class="btn btn-secondary" onclick="mostrarHistorialNotas()">Ver historial de notas</button>

                 <div id="historialNotas" class="historial-container hidden">
                  <h3>Historial de notas</h3>
                <div id="listaNotas"></div>
    </div>
            </section>
            
            <!-- Seguimiento de Estados -->
            <section id="seguimiento" class="section">
    <h2><i class="fas fa-chart-line"></i> Seguimiento de Estados</h2>
    <p>Visualiza tus tendencias emocionales y estad√≠sticas.</p>
    
    <div class="chart-container">
        <canvas id="emocionesChart"></canvas>
    </div>
    
    <div class="chart-controls">
        <button class="btn btn-secondary" onclick="mostrarGraficoPastel()">
            <i class="fas fa-chart-pie"></i> Gr√°fico de Pastel
        </button>
        <button class="btn btn-accent" onclick="mostrarGraficoBarras()">
            <i class="fas fa-chart-bar"></i> Gr√°fico de Barras
        </button>
        <button class="btn" onclick="mostrarGraficoLineas()">
            <i class="fas fa-chart-line"></i> Gr√°fico de L√≠neas
        </button>
    </div>
    
    <h3>Estad√≠sticas de emociones</h3>
    <div id="estadisticas">
        <p>No hay suficientes datos para mostrar estad√≠sticas. ¬°Comienza registrando tus emociones!</p>
    </div>
</section>
            
            <!-- Ejercicios Mentales -->
            <section id="ejercicios" class="section">
                <h2><i class="fas fa-spa"></i> Ejercicios Mentales</h2>
                <p>Practica estos ejercicios para mejorar tu bienestar mental.</p>
                
                <div class="exercise-grid">
                    <div class="exercise-card" onclick="iniciarEjercicio('respiraci√≥n')">
                        <div class="exercise-icon"><i class="fas fa-wind"></i></div>
                        <h3>Respiraci√≥n Consciente</h3>
                        <p>5 minutos - Enf√≥cate en tu respiraci√≥n para calmar la mente</p>
                    </div>
                    
                    <div class="exercise-card" onclick="iniciarEjercicio('gratitud')">
                        <div class="exercise-icon"><i class="fas fa-heart"></i></div>
                        <h3>Diario de Gratitud</h3>
                        <p>Escribe 3 cosas por las que est√©s agradecido hoy</p>
                    </div>
                    
                    <div class="exercise-card" onclick="iniciarEjercicio('mindfulness')">
                        <div class="exercise-icon"><i class="fas fa-leaf"></i></div>
                        <h3>Meditaci√≥n Mindfulness</h3>
                        <p>10 minutos - Observa tus pensamientos sin juzgarlos</p>
                    </div>
                </div>
                
                <div id="ejercicio-activo" class="hidden">
                    <!-- Contenido del ejercicio activo -->
                </div>
            </section>
            
            <!-- Retos Personales -->
            <section id="retos" class="section">
                <h2><i class="fas fa-bullseye"></i> Retos Personales</h2>
                <p>Establece y sigue tus objetivos de bienestar.</p>
                
                <div class="challenge-list" id="lista-retos">
                    <p>No tienes retos establecidos. ¬°Agrega uno para comenzar!</p>
                </div>
                
                <div class="input-group">
                    <input type="text" id="nuevo-reto" placeholder="Escribe tu nuevo reto...">
                    <button class="btn btn-secondary" onclick="agregarReto()"><i class="fas fa-plus"></i> Agregar</button>
                </div>
            </section>
            
          <section id="calendario" class="section">
    <h2><i class="fas fa-calendar-alt"></i> Calendario Emocional</h2>
    <p>Visualiza tus emociones registradas en el calendario.</p>
    
    <div class="calendar-controls">
        <button class="calendar-nav-btn" onclick="cambiarMes(-1)">‚Äπ Mes Anterior</button>
        <div class="calendar-title" id="titulo-mes">Cargando...</div>
        <button class="calendar-nav-btn" onclick="cambiarMes(1)">Mes Siguiente ‚Ä∫</button>
    </div>
    
    <div id="calendario-emociones" class="calendar-grid">
        <!-- El calendario se generar√° aqu√≠ autom√°ticamente -->
    </div>
</section>
            
            <!-- Respiraci√≥n Diaria -->
            <section id="respiracion" class="section">
                <h2><i class="fas fa-wind"></i> Respiraci√≥n Diaria</h2>
                <p>Practica la respiraci√≥n consciente para reducir el estr√©s y aumentar tu bienestar.</p>
                
                <div class="breathing-exercise">
                    <div class="breathing-circle" id="circulo-respiracion">
                        INHALA
                    </div>
                    <p class="breathing-instruction" id="instruccion-respiracion">Inhala profundamente por la nariz</p>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn" onclick="iniciarRespiracion()"><i class="fas fa-play"></i> Comenzar</button>
                        <button class="btn btn-secondary hidden" id="btn-detener" onclick="detenerRespiracion()"><i class="fas fa-stop"></i> Detener</button>
                    </div>
                </div>
                
                <h3>Tu progreso</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="dias-consecutivos">0</div>
                        <div class="stat-label">D√≠as consecutivos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sesiones-completadas">0</div>
                        <div class="stat-label">Sesiones completadas</div>
                    </div>
                </div>
            </section>
            
           <!-- Mascota Virtual - VERSI√ìN MEJORADA -->
<section id="mascota" class="section">
    <h2><i class="fas fa-paw"></i> Mascota Virtual</h2>
    <p>Tu compa√±ero de bienestar mental. <strong>Selecciona UNA mascota</strong> para comenzar tu aventura.</p>
    
    <!-- PRIMERO: Selecci√≥n de mascota -->
    <div class="mascota-seleccion-container">
       <h3>üêæ Esta es tu mascota seleccionada</h3>
        <div class="pet-selector-grid">
            <div class="pet-option-card" data-pet="axolote" onclick="seleccionarMascota('axolote')">
                <div class="pet-option-image">
                    <img src="imagvideos/axolo.png" alt="Axolote" class="pet-icon-large">
                </div>
                <div class="pet-option-info">
                    <h4>Axolote</h4>
                    <p>Amigable y curioso</p>
                    <div class="pet-traits">
                        <span class="trait">üíß Acu√°tico</span>
                        <span class="trait">üòä Pac√≠fico</span>
                    </div>
                </div>
            </div>
            
            <div class="pet-option-card" data-pet="dinosaurio" onclick="seleccionarMascota('dinosaurio')">
                <div class="pet-option-image">
                    <img src="imagvideos/dinosau.png" alt="Dinosaurio" class="pet-icon-large">
                </div>
                <div class="pet-option-info">
                    <h4>Dinosaurio</h4>
                    <p>Fuerte y juguet√≥n</p>
                    <div class="pet-traits">
                        <span class="trait">ü¶ñ Energ√©tico</span>
                        <span class="trait">‚ö° R√°pido</span>
                    </div>
                </div>
            </div>
            
            <div class="pet-option-card" data-pet="caracol" onclick="seleccionarMascota('caracol')">
                <div class="pet-option-image">
                    <img src="imagvideos/caracoli.png" alt="Caracol" class="pet-icon-large">
                </div>
                <div class="pet-option-info">
                    <h4>Caracol</h4>
                    <p>Tranquilo y sabio</p>
                    <div class="pet-traits">
                        <span class="trait">üêå Calmado</span>
                        <span class="trait">üåø Natural</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SEGUNDO: Mascota seleccionada y estad√≠sticas -->
    <div class="mascota-activa-container" id="mascota-activa-container" style="display: none;">
        <div class="mascota-header">
            <div class="mascota-display-section">
                <div class="pet-display-large" id="mascota-actual">
                    <div class="placeholder-mascota">
                        <i class="fas fa-paw" style="font-size: 4rem; color: var(--primary-light);"></i>
                        <p style="margin-top: 1rem; color: var(--text-light);">Selecciona tu mascota</p>
                    </div>
                    <div id="pet-media-container"></div>
                </div>
                <div class="mascota-info">
                    <div class="pet-status-large" id="estado-mascota">¬°Selecciona tu mascota para comenzar!</div>
                    <div class="mascota-nivel-info">
                        <div class="nivel-badge">
                            <span class="nivel-label">Nivel</span>
                            <span class="nivel-value" id="nivel-mascota">1</span>
                        </div>
                        <div class="exp-bar-container">
                            <div class="exp-label">Experiencia</div>
                            <div class="progress-bar-large">
                                <div class="progress-fill-large" id="barra-experiencia" style="width: 0%"></div>
                                <div class="exp-text" id="experiencia-texto">0/100</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="estadisticas-rapidas">
                <h4>üìä Estado Actual</h4>
                <div class="stats-grid-compact">
                    <div class="stat-item">
                        <div class="stat-icon">üíñ</div>
                        <div class="stat-content">
                            <div class="stat-value" id="nivel-felicidad">50</div>
                            <div class="stat-label">Felicidad</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">‚ö°</div>
                        <div class="stat-content">
                            <div class="stat-value" id="nivel-energia">50</div>
                            <div class="stat-label">Energ√≠a</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">üçé</div>
                        <div class="stat-content">
                            <div class="stat-value" id="nivel-hambre">50</div>
                            <div class="stat-label">Hambre</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-content">
                            <div class="stat-value" id="monedas-mascota">50</div>
                            <div class="stat-label">Monedas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TERCERO: Interacciones -->
        <div class="interacciones-container">
            <div class="interaccion-columna">
                <h4>üçï Alimentar</h4>
                <div class="food-grid">
                    <div class="food-card" onclick="alimentarMascota('zanahoria')">
                        <div class="food-icon-large">ü•ï</div>
                        <div class="food-info">
                            <div class="food-name">Zanahoria</div>
                            <div class="food-cost">2 monedas</div>
                        </div>
                    </div>
                    <div class="food-card" onclick="alimentarMascota('manzana')">
                        <div class="food-icon-large">üçé</div>
                        <div class="food-info">
                            <div class="food-name">Manzana</div>
                            <div class="food-cost">3 monedas</div>
                        </div>
                    </div>
                    <div class="food-card" onclick="alimentarMascota('pescado')">
                        <div class="food-icon-large">üêü</div>
                        <div class="food-info">
                            <div class="food-name">Pescado</div>
                            <div class="food-cost">4 monedas</div>
                        </div>
                    </div>
                    <div class="food-card" onclick="alimentarMascota('carne')">
                        <div class="food-icon-large">üçñ</div>
                        <div class="food-info">
                            <div class="food-name">Carne</div>
                            <div class="food-cost">5 monedas</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="interaccion-columna">
                <h4>üéÆ Juegos</h4>
                <div class="games-grid">
                    <button class="game-btn" onclick="jugarMascota('pelota')">
                        <div class="game-icon">üéæ</div>
                        <div class="game-text">Pelota</div>
                    </button>
                    <button class="game-btn" onclick="jugarMascota('cuerda')">
                        <div class="game-icon">ü™¢</div>
                        <div class="game-text">Cuerda</div>
                    </button>
                    <button class="game-btn" onclick="jugarMascota('pluma')">
                        <div class="game-icon">ü™∂</div>
                        <div class="game-text">Pluma</div>
                    </button>
                    <button class="game-btn" onclick="jugarMascota('escondite')">
                        <div class="game-icon">üëÄ</div>
                        <div class="game-text">Escondite</div>
                    </button>
                </div>
            </div>
            
            <div class="interaccion-columna">
                <h4>üíù Cuidados</h4>
                <div class="care-actions">
                    <button class="care-btn btn-accent" onclick="acariciarMascota()">
                        <i class="fas fa-hand-holding-heart"></i>
                        <span>Acariciar</span>
                    </button>
                    <button class="care-btn btn-secondary" onclick="descansarMascota()">
                        <i class="fas fa-bed"></i>
                        <span>Descansar</span>
                    </button>
                </div>
                
                <div class="mascota-tips">
                    <h5>üí° Consejos</h5>
                    <ul>
                        <li>Alimenta a tu mascota regularmente</li>
                        <li>Juega para aumentar su felicidad</li>
                        <li>Deja que descanse cuando est√© cansado</li>
                        <li>Las caricias mejoran su √°nimo</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
            <!-- Recursos -->
            <section id="recursos" class="section">
                <h2><i class="fas fa-info-circle"></i> Recursos de Ayuda</h2>
                <p>Encuentra informaci√≥n, gu√≠as y recursos para apoyar tu bienestar mental.</p>
                
                <div class="resource-grid">
                    <div class="resource-card">
                        <div class="resource-image" style="background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            <i class="fas fa-blog"></i>
                        </div>
                        <div class="resource-content">
                            <h3>Blog de Salud Mental</h3>
                            <p>Art√≠culos informativos sobre salud mental, t√©cnicas de autocuidado y experiencias personales.</p>
                            <a href="#" class="resource-link" onclick="mostrarBlog()">Ver art√≠culos <i class="fas fa-arrow-right"></i></a>
                        </div>
                    </div>
                    
                    <div class="resource-card">
                        <div class="resource-image" style="background-color: var(--secondary-light); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="resource-content">
                            <h3>Gu√≠as de Autoayuda</h3>
                            <p>Recursos pr√°cticos y gu√≠as paso a paso para manejar el estr√©s, ansiedad y mejorar tu bienestar.</p>
                            <a href="#" class="resource-link" onclick="mostrarGuias()">Ver gu√≠as <i class="fas fa-arrow-right"></i></a>
                        </div>
                    </div>
                    
                    <div class="resource-card">
                        <div class="resource-image" style="background-color: var(--accent-light); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="resource-content">
                            <h3>Foro de la Comunidad</h3>
                            <p>Conecta con otras personas, comparte experiencias y encuentra apoyo en nuestra comunidad.</p>
                            <a href="#" class="resource-link" onclick="mostrarForo()">Ir al foro <i class="fas fa-arrow-right"></i></a>
                        </div>
                    </div>
                    
                    <div class="resource-card">
                        <div class="resource-image" style="background-color: var(--success); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            <i class="fas fa-hand-holding-heart"></i>
                        </div>
                        <div class="resource-content">
                            <h3>Centros de Ayuda</h3>
                            <p>Encuentra profesionales y centros especializados en salud mental cerca de ti.</p>
                            <a href="#" class="resource-link" onclick="mostrarCentrosAyuda()">Buscar ayuda <i class="fas fa-arrow-right"></i></a>
                        </div>
                    </div>
                </div>
                
                <div id="contenido-recursos">
                    <!-- Aqu√≠ se mostrar√° el contenido espec√≠fico de cada recurso -->
                </div>
            </section>
            
            <!-- Perfil de Usuario -->
            <section id="perfil" class="section">
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar" id="avatar-usuario">
                            <!-- La inicial del usuario se mostrar√° aqu√≠ -->
                        </div>
                        <div class="profile-info">
                            <h2 id="nombre-usuario">Usuario</h2>
                            <p id="email-usuario">usuario@ejemplo.com</p>
                            <p>Miembro desde: <span id="fecha-registro">2023</span></p>
                        </div>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="dias-consecutivos-perfil">0</div>
                            <div class="profile-stat-label">D√≠as consecutivos</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="emociones-registradas">0</div>
                            <div class="profile-stat-label">Emociones registradas</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="retos-completados">0</div>
                            <div class="profile-stat-label">Retos completados</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="ejercicios-realizados">0</div>
                            <div class="profile-stat-label">Ejercicios realizados</div>
                        </div>
                    </div>
                    
                    <div class="profile-form">
                        <h3>Editar Informaci√≥n Personal</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="perfil-nombre">Nombre completo</label>
                                <input type="text" id="perfil-nombre" placeholder="Tu nombre completo">
                            </div>
                            <div class="form-group">
                                <label for="perfil-email">Correo electr√≥nico</label>
                                <input type="email" id="perfil-email" placeholder="tu@email.com">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="perfil-fecha-nacimiento">Fecha de nacimiento</label>
                                <input type="date" id="perfil-fecha-nacimiento">
                            </div>
                            <div class="form-group">
                                <label for="perfil-genero">G√©nero</label>
                                <select id="perfil-genero" style="padding: 0.75rem 1rem; border: 1px solid var(--light-gray); border-radius: var(--radius); font-size: 1rem; width: 100%;">
                                    <option value="">Seleccionar</option>
                                    <option value="femenino">Femenino</option>
                                    <option value="masculino">Masculino</option>
                                    <option value="otro">Otro</option>
                                    <option value="prefiero-no-decir">Prefiero no decir</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="perfil-bio">Biograf√≠a</label>
                            <textarea id="perfil-bio" placeholder="Cu√©ntanos un poco sobre ti..." style="min-height: 100px;"></textarea>
                        </div>
                        
                        <h3>Cambiar Contrase√±a</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="perfil-password-actual">Contrase√±a actual</label>
                                <input type="password" id="perfil-password-actual" placeholder="Tu contrase√±a actual">
                            </div>
                            <div class="form-group">
                                <label for="perfil-password-nueva">Nueva contrase√±a</label>
                                <input type="password" id="perfil-password-nueva" placeholder="Nueva contrase√±a">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="perfil-password-confirmar">Confirmar nueva contrase√±a</label>
                            <input type="password" id="perfil-password-confirmar" placeholder="Repite la nueva contrase√±a">
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button class="btn" onclick="guardarPerfil()"><i class="fas fa-save"></i> Guardar Cambios</button>
                            <button class="btn btn-secondary" onclick="cancelarEdicion()"><i class="fas fa-times"></i> Cancelar</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Footer -->
        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Mente Sana</h3>
                    <p>Tu espacio para el bienestar mental. Ofrecemos herramientas y recursos para mejorar tu salud emocional y mental.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Contacto</h3>
                    <p><i class="fas fa-envelope"></i> info@mentesana.com</p>
                    <p><i class="fas fa-phone"></i> +1 (555) 123-4567</p>
                    <p><i class="fas fa-map-marker-alt"></i> Calle Bienestar 123, Ciudad</p>
                </div>
                
                <div class="footer-section">
                    <h3>Recursos</h3>
                    <a href="#" onclick="showSection('recursos'); mostrarBlog();">Blog de Salud Mental</a>
                    <a href="#" onclick="showSection('recursos'); mostrarGuias();">Gu√≠as de Autoayuda</a>
                    <a href="#" onclick="showSection('recursos'); mostrarForo();">Foro de la Comunidad</a>
                    <a href="#" onclick="showSection('recursos'); mostrarCentrosAyuda();">Centros de Ayuda</a>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2023 Mente Sana. Todos los derechos reservados.</p>
            </div>
        </footer>
    </div>
<head>
    
    <script>
   
// ==================== CONFIGURACI√ìN API AUTO ====================
// Detectar autom√°ticamente si estamos en producci√≥n
function getApiBaseUrl() {
  // Si estamos en localhost, usa localhost
  if (window.location.hostname === "localhost" || 
      window.location.hostname === "127.0.0.1") {
    return "http://localhost:3000";
  }
  
  // Si estamos en Railway o producci√≥n - CAMBIA ESTA URL POR LA TUYA
  return "https://mindweb-production.up.railway.app";
}

const API_BASE_URL = getApiBaseUrl();
console.log("üîß API BASE URL detectada:", API_BASE_URL);

// Helper simple para obtener token (ajusta si usas otra clave)
function _getToken() {
  return localStorage.getItem('authToken') || localStorage.getItem('token') || null;
}

// Helper minimal API (detecta entorno autom√°ticamente)
async function apiFetch(path, options = {}) {
  const token = _getToken();
  const headers = Object.assign({}, options.headers || {}, {
    'Content-Type': 'application/json',
    ...(token ? { Authorization: `Bearer ${token}` } : {})
  });
  
  // ‚úÖ CORREGIDO: Usa API_BASE_URL din√°mica
  const resp = await fetch(`${API_BASE_URL}/api${path}`, {
    method: options.method || 'GET',
    headers,
    body: options.body ? JSON.stringify(options.body) : undefined
  });
  let payload = null;
  try { payload = await resp.json(); } catch(e) { payload = null; }
  if (!resp.ok) {
    const msg = payload?.error || payload?.message || `HTTP ${resp.status}`;
    const err = new Error(msg);
    err.payload = payload;
    throw err;
  }
  return payload;
}

// ==================== NAVEGACI√ìN ENTRE SECCIONES ====================
function showSection(section) {
    // Ocultar todas las secciones
    const sections = document.querySelectorAll('.section');
    sections.forEach(sec => sec.style.display = 'none');

    // Mostrar solo la que corresponde
    const target = document.getElementById(section);
    if (target) {
        target.style.display = 'block';

        // Si la secci√≥n es "perfil", cargamos datos del perfil
        if (section === 'perfil') {
            cargarDatosPerfil();
        }

        // Si la secci√≥n es "seguimiento", llamamos la funci√≥n para mostrar seguimiento
        if (section === 'seguimiento') {
            mostrarSeguimiento();
        }
    } else {
        console.warn(`No se encontr√≥ la secci√≥n con id="${section}"`);
    }
}

/* ---------- Navegaci√≥n / vistas ---------- */
function mostrarPantalla(idMostrar) {
    const pantallas = ['welcome-screen', 'login-screen', 'register-screen', 'main-app'];
    pantallas.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.classList.add('hidden');
    });
    const mostrar = document.getElementById(idMostrar);
    if (mostrar) mostrar.classList.remove('hidden');
}

/* ---------- Inicializaci√≥n al cargar p√°gina ---------- */
window.addEventListener('load', async function() {
    const authToken = localStorage.getItem('authToken');
    const user = localStorage.getItem('user');
    if (authToken && user) {
        mostrarPantalla('main-app');
        updateUserInfo();
        await loadUserData();
        setupUserAvatar();
    } else {
        mostrarPantalla('welcome-screen');
    }
    if (typeof inicializarCalendario === 'function') inicializarCalendario();
    setTimeout(()=>{ if (typeof inicializarGraficos === 'function') inicializarGraficos(); }, 500);
});



/* ---------- LOGIN CORREGIDO con apiFetch ---------- */
async function login() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    
    // Validaci√≥n mejorada
    if (!email || !password) { 
        alert('Por favor, completa todos los campos'); 
        return; 
    }

    // Mostrar indicador de carga
    const loginBtn = document.querySelector('#login-screen button[onclick="login()"]');
    const originalText = loginBtn?.textContent || 'Iniciar Sesi√≥n';
    if (loginBtn) {
        loginBtn.textContent = 'Iniciando sesi√≥n...';
        loginBtn.disabled = true;
    }

    try {
        console.log("üîê Intentando login con:", { email });
        
        // ‚úÖ CORRECTO: Usando apiFetch (que ya incluye /api/)
        const data = await apiFetch('/auth/login', {
            method: 'POST',
            body: { 
                email: email, 
                password: password 
            }
        });

        console.log("‚úÖ Login exitoso, datos recibidos:", data);

        if (!data.token) {
            throw new Error('No se recibi√≥ token del servidor');
        }

        // Guardar token
        localStorage.setItem('authToken', data.token);
        localStorage.setItem('token', data.token); // Backup

        // Guardar info del usuario
        localStorage.setItem('user', JSON.stringify(data.user));
        
        // Usar las propiedades correctas para SQLite
        const userName = data.user.Nombre || data.user.nombre || '';
        const userEmail = data.user.Correo || data.user.email || email;
        
        localStorage.setItem('userName', userName);
        localStorage.setItem('userEmail', userEmail);

        // üî• CR√çTICO: Asegurar que el idUsuario se guarda correctamente
        const idUsuario = data.user.IdUsuario || data.user.idUsuario || data.user.userId;
        if (idUsuario) {
            localStorage.setItem('idUsuario', idUsuario.toString());
            console.log("‚úÖ idUsuario guardado:", idUsuario);
        } else {
            console.warn("‚ö†Ô∏è No se recibi√≥ idUsuario del servidor, intentando extraer del token...");
            // Intentar extraer del token JWT
            try {
                const tokenParts = data.token.split('.');
                if (tokenParts.length === 3) {
                    const payload = JSON.parse(atob(tokenParts[1]));
                    if (payload.userId) {
                        localStorage.setItem('idUsuario', payload.userId.toString());
                        console.log("‚úÖ idUsuario extra√≠do del token:", payload.userId);
                    } else if (payload.idUsuario) {
                        localStorage.setItem('idUsuario', payload.idUsuario.toString());
                        console.log("‚úÖ idUsuario extra√≠do del token:", payload.idUsuario);
                    }
                }
            } catch (tokenErr) {
                console.error("‚ùå Error parseando token:", tokenErr);
                throw new Error('Error procesando la respuesta del servidor');
            }
        }

        // Verificar que tenemos idUsuario
        if (!localStorage.getItem('idUsuario')) {
            throw new Error('No se pudo obtener el ID de usuario. Contacta al soporte.');
        }

        // Guardar para mascotas
        localStorage.setItem("mascota_idUsuario", localStorage.getItem('idUsuario'));

        // Mostrar pantalla principal
        mostrarPantalla('main-app');
        updateUserInfo();
        setupUserAvatar();
        
        // Cargar datos del usuario (perfil, estad√≠sticas, etc.)
        setTimeout(async () => {
            try {
                await cargarDatosPerfil();
                await cargarEstadisticasPerfil();
                
                // Actualizar mascota despu√©s del login
                if (typeof forzarActualizacionMascota === "function") {
                    setTimeout(() => forzarActualizacionMascota(), 500);
                }
                
                // Cargar otros datos
                if (typeof cargarRetos === "function") {
                    cargarRetos();
                }
                
                if (typeof inicializarCalendario === "function") {
                    inicializarCalendario();
                }
                
                console.log("‚úÖ Todas las cargas completadas despu√©s del login");
            } catch (loadError) {
                console.warn("‚ö†Ô∏è Algunas cargas fallaron:", loadError);
            }
        }, 100);

        // Mostrar mensaje de bienvenida
        setTimeout(() => {
            const welcomeMsg = document.getElementById('welcome-message');
            if (welcomeMsg) {
                welcomeMsg.textContent = `¬°Bienvenido/a de nuevo, ${userName || email}!`;
                welcomeMsg.style.display = 'block';
                setTimeout(() => {
                    welcomeMsg.style.display = 'none';
                }, 3000);
            }
        }, 100);

    } catch (err) {
        console.error('‚ùå Error en login:', err);
        
        // Mensaje de error m√°s descriptivo
        let errorMsg = 'Error al iniciar sesi√≥n';
        
        if (err.message.includes('no encontrado') || err.message.includes('404') || err.payload?.error?.includes('no encontrado')) {
            errorMsg = 'Usuario no encontrado. Verifica tu correo o reg√≠strate.';
        } else if (err.message.includes('contrase√±a') || err.message.includes('401') || err.payload?.error?.includes('contrase√±a')) {
            errorMsg = 'Contrase√±a incorrecta. Intenta nuevamente.';
        } else if (err.message.includes('Network Error') || err.message.includes('Failed to fetch')) {
            errorMsg = 'Error de conexi√≥n. Verifica tu internet o intenta m√°s tarde.';
        } else if (err.message.includes('token') || err.message.includes('No se pudo obtener')) {
            errorMsg = 'Error en la respuesta del servidor. Intenta nuevamente.';
        } else {
            errorMsg = 'Error: ' + (err.message || 'Desconocido');
        }
        
        alert(errorMsg);
        
        // Limpiar campos de contrase√±a
        document.getElementById('login-password').value = '';
        
    } finally {
        // Restaurar bot√≥n
        if (loginBtn) {
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;
        }
    }
}

/* ---------- REGISTER CORREGIDO con apiFetch ---------- */
async function register() {
    const name = document.getElementById('register-name').value.trim();
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    const confirm = document.getElementById('register-confirm').value;
    
    // Validaci√≥n mejorada
    if (!name || !email || !password || !confirm) { 
        alert('Por favor, completa todos los campos'); 
        return; 
    }
    
    // Validar email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Por favor, ingresa un correo electr√≥nico v√°lido');
        return;
    }
    
    if (password.length < 6) {
        alert('La contrase√±a debe tener al menos 6 caracteres');
        return;
    }
    
    if (password !== confirm) { 
        alert('Las contrase√±as no coinciden'); 
        return; 
    }

    // Mostrar indicador de carga
    const registerBtn = document.querySelector('#register-screen button[onclick="register()"]');
    const originalText = registerBtn?.textContent || 'Registrarse';
    if (registerBtn) {
        registerBtn.textContent = 'Registrando...';
        registerBtn.disabled = true;
    }

    try {
        console.log("üìù Intentando registro con:", { name, email });
        
        // ‚úÖ CORRECTO: Usando apiFetch (que ya incluye /api/)
        const data = await apiFetch('/auth/register', {
            method: 'POST',
            body: { 
                nombre: name, 
                email: email, 
                password: password 
            }
        });

        console.log("‚úÖ Registro exitoso, datos recibidos:", data);

        if (!data.token) {
            throw new Error('No se recibi√≥ token del servidor');
        }

        // Guardar token
        localStorage.setItem('authToken', data.token);
        localStorage.setItem('token', data.token); // Backup

        // Guardar info del usuario
        localStorage.setItem('user', JSON.stringify(data.user));
        
        // Usar propiedades correctas para SQLite
        const userName = data.user.Nombre || data.user.nombre || name;
        const userEmail = data.user.Correo || data.user.email || email;
        
        localStorage.setItem('userName', userName);
        localStorage.setItem('userEmail', userEmail);

        // üî• CR√çTICO: Asegurar idUsuario
        const idUsuario = data.user.IdUsuario || data.user.idUsuario || data.user.userId;
        if (idUsuario) {
            localStorage.setItem('idUsuario', idUsuario.toString());
            console.log("‚úÖ idUsuario guardado en registro:", idUsuario);
        } else {
            console.warn("‚ö†Ô∏è No se recibi√≥ idUsuario en registro");
            // Intentar del token
            try {
                const tokenParts = data.token.split('.');
                if (tokenParts.length === 3) {
                    const payload = JSON.parse(atob(tokenParts[1]));
                    if (payload.userId) {
                        localStorage.setItem('idUsuario', payload.userId.toString());
                        console.log("‚úÖ idUsuario extra√≠do del token:", payload.userId);
                    } else if (payload.idUsuario) {
                        localStorage.setItem('idUsuario', payload.idUsuario.toString());
                        console.log("‚úÖ idUsuario extra√≠do del token:", payload.idUsuario);
                    }
                }
            } catch (tokenErr) {
                console.error("‚ùå Error parseando token:", tokenErr);
                throw new Error('Error procesando la respuesta del servidor');
            }
        }

        // Verificar que tenemos idUsuario
        if (!localStorage.getItem('idUsuario')) {
            throw new Error('No se pudo obtener el ID de usuario. Contacta al soporte.');
        }

        // Guardar para mascotas
        localStorage.setItem("mascota_idUsuario", localStorage.getItem('idUsuario'));

        // Mostrar pantalla principal
        mostrarPantalla('main-app');
        updateUserInfo();
        setupUserAvatar();

        // Cargar datos despu√©s del registro
        setTimeout(async () => {
            try {
                await cargarDatosPerfil();
                await cargarEstadisticasPerfil();
                
                // Crear perfil inicial si no existe
                await apiFetch('/perfil/guardar', {
                    method: 'POST',
                    body: {
                        idUsuario: parseInt(localStorage.getItem('idUsuario')),
                        nombreCompleto: userName,
                        correoElectronico: userEmail,
                        fechaDeNacimiento: '',
                        genero: '',
                        biografia: ''
                    }
                });
                
                console.log("‚úÖ Perfil inicial creado");
            } catch (profileError) {
                console.warn("‚ö†Ô∏è Error creando perfil inicial:", profileError);
            }
        }, 200);

        // Mensaje de bienvenida
        setTimeout(() => {
            const msg = document.getElementById('welcome-message');
            if (msg) {
                msg.textContent = `¬°Bienvenido/a a MindWeb, ${userName}!`;
                msg.style.display = 'block';
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 3000);
            }
            
            // Mostrar tutorial inicial si es primer registro
            const firstTime = !localStorage.getItem('tutorialVisto');
            if (firstTime) {
                alert('üéâ ¬°Bienvenido a MindWeb! Te recomendamos completar tu perfil y explorar las diferentes secciones para conocer todas las funciones disponibles.');
                localStorage.setItem('tutorialVisto', 'true');
            }
        }, 100);

    } catch (err) {
        console.error('‚ùå Error en registro:', err);
        
        // Mensajes de error m√°s espec√≠ficos
        let errorMsg = 'Error al registrarse';
        
        if (err.message.includes('ya existe') || err.message.includes('duplicate') || err.payload?.error?.includes('ya existe')) {
            errorMsg = 'Este correo ya est√° registrado. ¬øQuieres iniciar sesi√≥n?';
        } else if (err.message.includes('Network Error') || err.message.includes('Failed to fetch')) {
            errorMsg = 'Error de conexi√≥n. Verifica tu internet e intenta nuevamente.';
        } else if (err.message.includes('email') || err.message.includes('correo')) {
            errorMsg = 'Por favor, ingresa un correo electr√≥nico v√°lido.';
        } else if (err.message.includes('No se pudo obtener')) {
            errorMsg = 'Error en la respuesta del servidor. Intenta nuevamente.';
        } else {
            errorMsg = 'Error: ' + (err.message || 'Desconocido');
        }
        
        alert(errorMsg);
        
        // Limpiar campos de contrase√±a
        document.getElementById('register-password').value = '';
        document.getElementById('register-confirm').value = '';
        
    } finally {
        // Restaurar bot√≥n
        if (registerBtn) {
            registerBtn.textContent = originalText;
            registerBtn.disabled = false;
        }
    }
}

// üî• FUNCI√ìN AUXILIAR PARA CARGAR ESTAD√çSTICAS DESPU√âS DEL LOGIN
async function cargarEstadisticasPerfil() {
    try {
        const data = await apiFetch('/estadisticas/generales');
        
        // Guardar estad√≠sticas en localStorage
        localStorage.setItem('emocionesRegistradas', data.emocionesRegistradas || 0);
        localStorage.setItem('ejerciciosRealizados', data.ejerciciosRealizados || 0);
        localStorage.setItem('retosCompletados', data.retosCompletados || 0);
        localStorage.setItem('diasConsecutivos', data.diasConsecutivos || 0);

        // Actualizar UI si existe
        if (typeof updateProfileStats === 'function') {
            updateProfileStats();
        }
        
        console.log("üìä Estad√≠sticas cargadas:", data);
        return data;
    } catch (error) {
        console.warn("‚ö†Ô∏è No se pudieron cargar estad√≠sticas:", error);
        // Usar valores por defecto
        return {
            emocionesRegistradas: 0,
            ejerciciosRealizados: 0,
            retosCompletados: 0,
            diasConsecutivos: 0
        };
    }
}

// üî• MEJORAR LA VERIFICACI√ìN DE SESI√ìN
function verificarSesion() {
    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
    const user = localStorage.getItem('user');
    const idUsuario = localStorage.getItem('idUsuario');
    
    if (token && user && idUsuario) {
        try {
            const userData = JSON.parse(user);
            console.log("üîê Sesi√≥n activa - Usuario:", userData.Nombre || userData.nombre || 'Usuario');
            return true;
        } catch (e) {
            console.error("‚ùå Error parseando datos de usuario:", e);
            return false;
        }
    } else {
        console.log("üîì No hay sesi√≥n activa");
        
        // Limpiar datos inconsistentes
        if (token && !user) {
            console.warn("‚ö†Ô∏è Token sin datos de usuario, limpiando...");
            localStorage.removeItem('authToken');
            localStorage.removeItem('token');
        }
        
        return false;
    }
}

// ==================== CARGAR PERFIL DESDE LA API (SQLite) ====================
async function cargarDatosPerfil() {
    try {
        // Asegurarnos de tener el idUsuario
        const idUsuario = initializeUserId();
        
        if (!idUsuario) {
            console.warn("‚ùå No hay idUsuario en localStorage - no se puede cargar perfil");
            // Mostrar datos b√°sicos del localStorage
            updateUserInfo();
            setupUserAvatar();
            updateProfileStats();
            return;
        }

        console.log("üì• Cargando perfil para idUsuario:", idUsuario);

        // Llamada al backend SQLite - SIN /api/ en la ruta
        let data;
        try {
            data = await apiRequest(`/perfil/completo?idUsuario=${idUsuario}`);
        } catch (apiError) {
            console.warn("‚ö†Ô∏è No se pudo cargar perfil desde SQLite, usando datos locales:", apiError);
            // Si falla la API, usar datos del localStorage
            updateUserInfo();
            setupUserAvatar();
            updateProfileStats();
            return;
        }
        
        console.log("üì• Datos del perfil recibidos:", data);

        // Rellenar formulario si los elementos existen
        const perfilNombre = document.getElementById('perfil-nombre');
        const perfilEmail = document.getElementById('perfil-email');
        const perfilFecha = document.getElementById('perfil-fecha-nacimiento');
        const perfilGenero = document.getElementById('perfil-genero');
        const perfilBio = document.getElementById('perfil-bio');
        
        if (perfilNombre) perfilNombre.value = data.NombreCompleto || '';
        if (perfilEmail) perfilEmail.value = data.CorreoElectronico || '';
        
        // Formatear fecha correctamente
        if (perfilFecha && data.FechaDeNacimiento) {
            const fecha = new Date(data.FechaDeNacimiento);
            perfilFecha.value = fecha.toISOString().split('T')[0];
        }
        
        if (perfilGenero) perfilGenero.value = data.Genero || '';
        if (perfilBio) perfilBio.value = data.Biografia || '';

        // Guardar datos en localStorage para usar despu√©s
        if (data.NombreCompleto) {
            localStorage.setItem('userName', data.NombreCompleto);
        }
        if (data.CorreoElectronico) {
            localStorage.setItem('userEmail', data.CorreoElectronico);
        }

        // Actualizar cabecera del perfil
        updateUserInfo();
        setupUserAvatar();
        
        // Formatear fecha de registro si existe el elemento
        const fechaRegistroElem = document.getElementById('fecha-registro');
        if (fechaRegistroElem) {
            if (data.MiembroDesde) {
                const fechaRegistro = new Date(data.MiembroDesde);
                fechaRegistroElem.textContent = fechaRegistro.getFullYear();
            } else {
                fechaRegistroElem.textContent = new Date().getFullYear();
            }
        }

        // Intentar cargar estad√≠sticas desde el endpoint
        await cargarEstadisticasPerfil();
        
        console.log("‚úÖ Perfil cargado exitosamente desde SQLite");

    } catch (err) {
        console.error('‚ùå Error al cargar perfil:', err);
        // Fallback: mostrar datos b√°sicos
        updateUserInfo();
        setupUserAvatar();
        updateProfileStats();
    }
}

// ==================== GUARDAR PERFIL EN SQLite ====================
async function guardarPerfil() {
    try {
        const idUsuario = localStorage.getItem('idUsuario');
        if (!idUsuario) {
            alert('Error: No se encontr√≥ el ID de usuario');
            return;
        }

        const body = {
            idUsuario: parseInt(idUsuario),
            nombreCompleto: document.getElementById('perfil-nombre').value,
            correoElectronico: document.getElementById('perfil-email').value,
            fechaDeNacimiento: document.getElementById('perfil-fecha-nacimiento').value,
            genero: document.getElementById('perfil-genero').value,
            biografia: document.getElementById('perfil-bio').value
        };

        // Solo incluir campos de contrase√±a si est√°n completos
        const contrasenaActual = document.getElementById('perfil-password-actual').value;
        const nuevaContrasena = document.getElementById('perfil-password-nueva').value;
        const confirmarNuevaContrasena = document.getElementById('perfil-password-confirmar').value;
        
        if (contrasenaActual || nuevaContrasena || confirmarNuevaContrasena) {
            body.contrasenaActual = contrasenaActual;
            body.nuevaContrasena = nuevaContrasena;
            body.confirmarNuevaContrasena = confirmarNuevaContrasena;
        }

        console.log("üì§ Enviando datos a SQLite:", body);

        // Llamada al backend SQLite - SIN /api/ en la ruta
        const result = await apiRequest('/perfil/guardar', {
            method: 'POST',
            body: body
        });

        // Limpiar campos de contrase√±a
        document.getElementById('perfil-password-actual').value = '';
        document.getElementById('perfil-password-nueva').value = '';
        document.getElementById('perfil-password-confirmar').value = '';

        // Guardar en localStorage para uso inmediato
        localStorage.setItem('userName', body.nombreCompleto);
        localStorage.setItem('userEmail', body.correoElectronico);

        // Actualizar la informaci√≥n en la UI
        updateUserInfo();
        setupUserAvatar();
        
        alert("‚úÖ Perfil actualizado correctamente en SQLite");
        
    } catch (err) {
        console.error('Error al guardar perfil:', err);
        alert('‚ùå Error al guardar perfil: ' + (err.message || 'Error desconocido'));
    }
}

// ==================== CARGAR ESTAD√çSTICAS DESDE SQLite ====================
async function cargarEstadisticasPerfil() {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            console.warn("No hay token, no se pueden cargar estad√≠sticas");
            return;
        }

        // Llamada al endpoint de estad√≠sticas - SIN /api/ en la ruta
        const data = await apiRequest('/estadisticas/generales', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        console.log("üìä Estad√≠sticas recibidas:", data);

        // Guardar estad√≠sticas en localStorage
        localStorage.setItem('emocionesRegistradas', data.emocionesRegistradas || 0);
        localStorage.setItem('ejerciciosRealizados', data.ejerciciosRealizados || 0);
        localStorage.setItem('retosCompletados', data.retosCompletados || 0);
        localStorage.setItem('diasConsecutivos', data.diasConsecutivos || 0);

        // Actualizar UI
        updateProfileStats();

    } catch (error) {
        console.warn("‚ö†Ô∏è No se pudieron cargar estad√≠sticas:", error);
        // Usar valores por defecto
        updateProfileStats();
    }
}

// ==================== FUNCION apiRequest CORREGIDA ====================
// Aseg√∫rate de que esta funci√≥n no a√±ada /api/ autom√°ticamente
async function apiRequest(endpoint, options = {}) {
    const baseUrl = ''; // Vac√≠o para rutas relativas
    const url = baseUrl + endpoint;
    
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        }
    };

    const config = {
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...options.headers
        }
    };

    if (config.body && typeof config.body === 'object') {
        config.body = JSON.stringify(config.body);
    }

    console.log(`üåê Llamando a: ${url}`, config);

    const response = await fetch(url, config);
    
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error ${response.status}: ${errorText}`);
    }

    return await response.json();
}

/* ---------- loadUserData ---------- */
async function loadUserData() {
    try {
        // üî• COMENTA O ELIMINA ESTA L√çNEA QUE CAUSA EL ERROR:
        // const emocionesData = await apiRequest('/emociones');
        
        // üî• REEMPLAZA con esto:
        let emocionesData = [];
        
        // El resto de tu c√≥digo IGUAL:
        emociones = (emocionesData || []).map(e => ({
            tipo: (e.Nombre || e.nombre || e.TipoEmocion || '').toLowerCase(),
            fecha: e.Fecha || e.FechaRegistro || new Date().toISOString().split('T')[0],
            hora: e.Hora || new Date().toLocaleTimeString(),
            notas: e.Nota || ''
        }));
        
        if (typeof inicializarCalendario === 'function') inicializarCalendario();
    } catch (err) {
        // üî• CAMBIA esto tambi√©n:
        emociones = [];
    }
}
/* ---------------------------
  inicio del codigo de emociones 
   --------------------------- */
let emocion = [];            // <- usa este nombre exactamente
let emocionSeleccionada = null;
/* ---------------------------
   Guardar emoci√≥n con confirmaci√≥n visual
   --------------------------- */
async function guardarEmocion(tipoEmocion) {
  console.log('guardarEmocion llamado con:', tipoEmocion);
  const notasInput = document.getElementById('notas-emocion');
  const notas = (notasInput?.value || '').trim();
  const token = _getToken();

  if (!token) {
    alert('‚ö†Ô∏è Debes iniciar sesi√≥n para registrar una emoci√≥n.');
    return;
  }
  if (!tipoEmocion) {
    alert('Selecciona una emoci√≥n antes de guardar.');
    return;
  }

  try {
    await apiFetch('/emociones/registrar', {
      method: 'POST',
      body: { tipo: tipoEmocion, notas }
    });

    console.log('‚úî Emoci√≥n enviada al servidor');

    // limpiar campo de notas
    if (notasInput) notasInput.value = '';

    // recargar lista
    await cargarEmocionesDesdeBD();

    // refrescar historial si est√° visible
    const historial = document.getElementById('historialNotas');
    if (historial && historial.style.display === 'block') mostrarHistorialNotas(true);

    // mostrar confirmaci√≥n visual
    mostrarMensajeConfirmacion('üåø Emoci√≥n guardada correctamente');

  } catch (err) {
    console.error('Error guardando emoci√≥n:', err);
    alert('Error al registrar emoci√≥n: ' + (err.message || 'Error desconocido'));
  }
}

/* ---------------------------
   Mensaje de confirmaci√≥n animado
   --------------------------- */
function mostrarMensajeConfirmacion(texto) {
  let msg = document.getElementById('mensajeConfirmacion');
  if (!msg) {
    msg = document.createElement('div');
    msg.id = 'mensajeConfirmacion';
    msg.style.position = 'fixed';
    msg.style.top = '20px';
    msg.style.right = '20px';
    msg.style.backgroundColor = '#4CAF50';
    msg.style.color = 'white';
    msg.style.padding = '12px 18px';
    msg.style.borderRadius = '8px';
    msg.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    msg.style.fontSize = '15px';
    msg.style.zIndex = '9999';
    msg.style.opacity = '0';
    msg.style.transition = 'opacity 0.5s, transform 0.5s';
    document.body.appendChild(msg);
  }

  msg.textContent = texto;
  msg.style.opacity = '1';
  msg.style.transform = 'translateY(0)';

  // desaparecer despu√©s de 3 segundos
  setTimeout(() => {
    msg.style.opacity = '0';
    msg.style.transform = 'translateY(-10px)';
  }, 3000);
}

/* ---------------------------
   Cargar emociones desde BD
   --------------------------- */
async function cargarEmocionesDesdeBD() {
  console.log('cargarEmocionesDesdeBD iniciado');
  const token = _getToken();
  if (!token) { console.log('No hay token ‚Äî no se cargan emociones'); return; }

  try {
    const data = await apiFetch('/emociones/usuario');
    console.log('Respuesta /emociones/usuario:', data);
    emocion = (Array.isArray(data) ? data : []).map(r => ({
      tipo: (r.Nombre || r.nombre || r.Emocion || '').toString().toLowerCase(),
      notas: (r.Nota || r.nota || r.Notas || '').toString(),
      fecha: (r.Fecha || r.FechaRegistro || r.fecha || '').toString().split('T')[0] || new Date().toISOString().split('T')[0],
      hora: (r.Hora || r.hora || (r.FechaRegistro ? new Date(r.FechaRegistro).toLocaleTimeString() : '')) || new Date().toLocaleTimeString()
    }));
    console.log('emocion normalizadas:', emocion);
  } catch (err) {
    console.error('Error cargando emociones desde BD:', err);
  }
}

/* ---------------------------
   Mostrar / ocultar historial
   --------------------------- */
function mostrarHistorialNotas(forceShow = undefined) {
  const historial = document.getElementById('historialNotas');
  const lista = document.getElementById('listaNotas');
  if (!historial || !lista) {
    console.error('No se encontraron #historialNotas o #listaNotas en el DOM');
    return;
  }

  const estaOculto = historial.classList.contains('hidden') || historial.style.display === 'none';
  const deberiaMostrar = typeof forceShow === 'boolean' ? forceShow : estaOculto;

  if (!deberiaMostrar) {
    historial.classList.add('hidden');
    historial.style.display = 'none';
    console.log('Historial ocultado');
    return;
  }

  // Mostrar historial
  lista.innerHTML = '';
  if (!Array.isArray(emocion) || emocion.length === 0) {
    lista.innerHTML = '<p style="color:#1565c0; margin:8px 0;">No hay notas registradas a√∫n.</p>';
  } else {
    const frag = document.createDocumentFragment();
    emocion.forEach(e => {
      const nota = document.createElement('div');
      nota.className = 'nota';

      const em = document.createElement('span');
      em.className = 'emoji';
      em.textContent = getEmojiPorEmocion(e.tipo);

      const cont = document.createElement('div');
      cont.className = 'contenido';

      const txt = document.createElement('div');
      txt.className = 'texto';
      txt.textContent = 'üìù ' + (e.notas || '(sin notas)');

      const f = document.createElement('div');
      f.className = 'fecha';
      f.textContent = `${e.fecha || ''} ${e.hora || ''}`;

      cont.appendChild(txt);
      cont.appendChild(f);
      nota.appendChild(em);
      nota.appendChild(cont);
      frag.appendChild(nota);
    });
    lista.appendChild(frag);
  }

  historial.classList.remove('hidden');
  historial.style.display = 'block';
  console.log('Historial mostrado');
}

/* ---------------------------
   Mapeo de emojis
   --------------------------- */
function getEmojiPorEmocion(tipo) {
  const mapa = {
    feliz: 'üòä',
    triste: 'üò¢',
    enojado: 'üò†',
    ansioso: 'üò∞',
    calmado: 'üòå',
    energico: 'üòÑ',
    confundido: 'üòï',
    agradecido: 'üôè'
  };
  return mapa[(tipo || '').toLowerCase()] || '‚ùì';
}

/* ---------------------------
   Selecci√≥n en el grid
   --------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const items = document.querySelectorAll('.emotion');
  if (!items) console.warn('No se encontraron .emotion en DOM');
  items.forEach(it => {
    it.addEventListener('click', () => {
      items.forEach(x => x.classList.remove('selected'));
      it.classList.add('selected');
      emocionSeleccionada = it.getAttribute('data-emotion');
      console.log('üíö Emoci√≥n seleccionada:', emocionSeleccionada);
    });
  });

  // Cargar emociones al iniciar si ya hay token
  if (_getToken()) {
    cargarEmocionesDesdeBD().then(() => {
      console.log('Carga inicial completa');
    });
  }
});

// Para onclick en HTML
function getEmocionSeleccionada() { return emocionSeleccionada; }

// Paleta de colores
const PALETA = {
    feliz: 'rgba(0,200,83,1)',
    triste: 'rgba(41,98,255,1)',
    enojado: 'rgba(213,0,0,1)',
    ansioso: 'rgba(255,109,0,1)',
    calmado: 'rgba(142,36,170,1)',
    energico: 'rgba(255,214,0,1)',
    confundido: 'rgba(109,76,65,1)',
    agradecido: 'rgba(0,150,136,1)',
    neutral: 'rgba(158,158,158,1)'
};

// Variable global para emociones de gr√°ficas
let emociones = [];

// ----------- HELPER: limpiar emociones al cambiar usuario -----------
function limpiarEmocionesGraficas() {
    emociones = [];
}

// ----------- HELPER: cargar emociones SOLO del usuario actual -----------
async function cargarEmocionesGraficas() {
    const token = localStorage.getItem('authToken');

    if (!token) {
        console.warn("No hay token, limpiando emociones de gr√°ficas.");
        limpiarEmocionesGraficas();
        return;
    }

    try {
        // ‚úÖ CORREGIDO: Usa apiFetch en lugar de fetch directo
        const data = await apiFetch('/emociones/usuario');

        // Si el usuario no tiene emociones ‚Üí limpia
        if (!Array.isArray(data) || data.length === 0) {
            emociones = [];
            return;
        }

        // Normalizar formato para gr√°ficas
        emociones = data.map(e => ({
            tipo: (e.Nombre || e.nombre || e.Emocion || "").toLowerCase(),
            nota: e.Nota || "",
            fecha: e.Fecha || ""
        }));

    } catch (error) {
        console.error("Error al cargar emociones:", error);
        limpiarEmocionesGraficas();
    }
}

// =========================
// CONFIGURACI√ìN DE CANVAS 
// ==========================
function prepareCanvas() {
    const canvas = document.getElementById("emocionesChart");
    if (!canvas) throw new Error("Canvas no encontrado #emocionesChart");

    const cssW = canvas.offsetWidth;
    const cssH = canvas.offsetHeight || 300;
    const dpr = window.devicePixelRatio || 1;

    canvas.width = cssW * dpr;
    canvas.height = cssH * dpr;
    canvas.style.width = cssW + "px";
    canvas.style.height = cssH + "px";

    const ctx = canvas.getContext("2d");

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, cssW, cssH);

    return { canvas, ctx, cssWidth: cssW, cssHeight: cssH };
}

function safeDestroyChart(canvas, ctx) {
    if (window.emocionesChart) {
        try { window.emocionesChart.destroy(); } catch(e) {}
        ctx.setTransform(1,0,0,1,0,0);
        ctx.clearRect(0,0,canvas.width,canvas.height);
    }
}

// ===============================
// CONTAR EMOCIONES
// ==============================
function contarEmociones() {
    const conteo = {};
    emociones.forEach(e => {
        const t = e.tipo || "desconocido";
        conteo[t] = (conteo[t] || 0) + 1;
    });
    return conteo;
}

// ===========================================================
// GRAFICO PASTEL
// ===========================================================
async function mostrarGraficoPastel() {
    await cargarEmocionesGraficas();

    const info = prepareCanvas();
    const { canvas, ctx, cssWidth, cssHeight } = info;
    safeDestroyChart(canvas, ctx);

    const conteo = contarEmociones();
    const etiquetas = Object.keys(conteo);
    const valores = Object.values(conteo);

    if (etiquetas.length === 0) {
        ctx.fillStyle = "#777";
        ctx.textAlign = "center";
        ctx.font = "14px Arial";
        ctx.fillText("No hay emociones registradas.", cssWidth/2, cssHeight/2);
        return;
    }

    const colores = etiquetas.map(t => PALETA[t] || PALETA.neutral);

    window.emocionesChart = new Chart(ctx, {
        type: "doughnut",
        data: { labels: etiquetas, datasets: [{ data: valores, backgroundColor: colores }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "60%"
        }
    });
}

// ===========================================================
// GRAFICO BARRAS
// ===========================================================
async function mostrarGraficoBarras() {
    await cargarEmocionesGraficas();

    const info = prepareCanvas();
    const { canvas, ctx, cssWidth, cssHeight } = info;
    safeDestroyChart(canvas, ctx);

    const conteo = contarEmociones();
    const etiquetas = Object.keys(conteo);
    const valores = Object.values(conteo);

    if (etiquetas.length === 0) {
        ctx.fillStyle = "#777";
        ctx.textAlign = "center";
        ctx.font = "14px Arial";
        ctx.fillText("No hay emociones registradas.", cssWidth/2, cssHeight/2);
        return;
    }

    window.emocionesChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: etiquetas,
            datasets: [{
                label: "Cantidad",
                data: valores,
                backgroundColor: etiquetas.map(t => PALETA[t] || PALETA.neutral)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// ===========================================================
// GRAFICO LINEAS
// ===========================================================
async function mostrarGraficoLineas() {
    await cargarEmocionesGraficas();

    const info = prepareCanvas();
    const { canvas, ctx, cssWidth, cssHeight } = info;
    safeDestroyChart(canvas, ctx);

    if (emociones.length === 0) {
        ctx.fillStyle = "#777";
        ctx.textAlign = "center";
        ctx.font = "14px Arial";
        ctx.fillText("No hay emociones registradas.", cssWidth/2, cssHeight/2);
        return;
    }

    // agrupar por fecha
    const agrup = {};
    emociones.forEach(e => {
        const f = e.fecha?.split("T")[0] || "";
        agrup[f] = agrup[f] || 0;
        agrup[f]++;
    });

    const fechas = Object.keys(agrup).sort();
    const valores = fechas.map(f => agrup[f]);

    window.emocionesChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: fechas,
            datasets: [{
                label: "Emociones",
                data: valores,
                borderColor: "#4A6FA5",
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// ===========================================================
// FUNCI√ìN PUBLICA PARA CAMBIAR ENTRE GRAFICAS
// ===========================================================
function actualizarYMostrar(tipo = "pastel") {
    if (tipo === "barras") mostrarGraficoBarras();
    else if (tipo === "lineas") mostrarGraficoLineas();
    else mostrarGraficoPastel();
}

// ===========================================================
// REINICIO AUTOM√ÅTICO CUANDO SE ABRE "SEGUIMIENTO"
// ===========================================================
function mostrarSeguimiento() {
    const sec = document.getElementById("seguimiento");
    if (!sec) return;

    sec.style.display = "block";

    setTimeout(() => actualizarYMostrar("pastel"), 200);
}

// =====================================================
// üü¶ RETOS - Cargar, Agregar y Marcar (Cumplido / Fallido)
// =====================================================

// üîπ Cargar todos los retos del usuario
async function cargarRetos() {
    try {
        const data = await apiCall("/api/retos");
        
        if (data && Array.isArray(data)) {
            renderRetos(data);
        } else {
            console.error("‚ùå Error: Datos de retos no son un array", data);
            renderRetos([]);
        }

    } catch (err) {
        console.error("‚ùå Error cargando retos:", err);
        renderRetos([]);
    }
}

// üîπ Agregar un nuevo reto
async function agregarReto() {
    const titulo = document.getElementById("nuevo-reto").value.trim();
    if (titulo === "") return;

    try {
        const data = await apiCall("/api/retos", {
            method: "POST",
            body: JSON.stringify({ Titulo: titulo })
        });

        if (data && data.IdReto) {
            document.getElementById("nuevo-reto").value = "";
            cargarRetos(); // recargar lista
        } else {
            console.error("‚ùå Error: No se pudo crear el reto", data);
        }

    } catch (err) {
        console.error("‚ùå Error agregando reto:", err);
    }
}

// üîπ Marcar como cumplido (true) o fallido (false)
async function marcarReto(id, cumplido) {
    try {
        const data = await apiCall(`/api/retos/${id}`, {
            method: "PUT",
            body: JSON.stringify({ Cumplido: cumplido })
        });

        if (data && data.IdReto) {
            cargarRetos();
        } else {
            console.error("‚ùå Error: No se pudo actualizar el reto", data);
        }

    } catch (err) {
        console.error("‚ùå Error actualizando reto:", err);
    }
}

// üîπ Eliminar reto (opcional)
async function eliminarReto(id) {
    if (!confirm("¬øEst√°s seguro de que quieres eliminar este reto?")) return;

    try {
        const result = await apiCall(`/api/retos/${id}`, {
            method: "DELETE"
        });

        if (result && result.message) {
            cargarRetos();
        } else {
            console.error("‚ùå Error: No se pudo eliminar el reto", result);
        }

    } catch (err) {
        console.error("‚ùå Error eliminando reto:", err);
    }
}

// =====================================================
// üîπ Renderizar Retos en el HTML
// =====================================================
function renderRetos(retos) {
    const cont = document.getElementById("lista-retos");
    
    if (!cont) {
        console.error("‚ùå Error: No se encontr√≥ el contenedor de retos");
        return;
    }

    cont.innerHTML = "";

    // ‚úÖ VERIFICAR que retos sea un array
    if (!Array.isArray(retos)) {
        console.error("‚ùå Error: retos no es un array", retos);
        cont.innerHTML = `<p class="error">Error al cargar los retos</p>`;
        return;
    }

    if (retos.length === 0) {
        cont.innerHTML = `
            <div class="no-retos">
                <p>üéØ No tienes retos establecidos</p>
                <p class="subtitulo">¬°Agrega uno para comenzar!</p>
            </div>
        `;
        return;
    }

    retos.forEach(r => {
        const div = document.createElement("div");
        div.classList.add("reto-item");
        
        // Agregar clase seg√∫n el estado
        if (r.Estado === 'Cumplido') {
            div.classList.add('completado');
        } else if (r.Estado === 'Fallido') {
            div.classList.add('fallido');
        }

        div.innerHTML = `
            <span class="reto-titulo ${r.Estado === 'Cumplido' ? 'tachado' : ''}">
                ${r.Titulo}
            </span>
            
            <div class="reto-fecha">
                ${new Date(r.FechaCreacion).toLocaleDateString()}
            </div>

            <div class="reto-acciones">
                ${r.Estado === 'Pendiente' ? `
                    <button class="btn-check" onclick="marcarReto(${r.IdReto}, true)" title="Marcar como cumplido">
                        ‚úî
                    </button>
                    <button class="btn-fail" onclick="marcarReto(${r.IdReto}, false)" title="Marcar como fallido">
                        ‚úñ
                    </button>
                ` : ''}
                
                <button class="btn-delete" onclick="eliminarReto(${r.IdReto})" title="Eliminar reto">
                    üóëÔ∏è
                </button>
            </div>
            
            ${r.Estado !== 'Pendiente' ? `
                <div class="reto-estado ${r.Estado === 'Cumplido' ? 'estado-cumplido' : 'estado-fallido'}">
                    ${r.Estado} ${r.FechaCumplido ? ' - ' + new Date(r.FechaCumplido).toLocaleDateString() : ''}
                </div>
            ` : ''}
        `;

        cont.appendChild(div);
    });
}

// =====================================================
// üîπ INICIALIZACI√ìN DE RETOS (INDEPENDIENTE)
// =====================================================
function inicializarRetos() {
    console.log("üéØ Inicializando m√≥dulo de retos...");
    
    // Cargar retos al iniciar
    cargarRetos();
    
    // Agregar event listener al bot√≥n de agregar
    const btnAgregar = document.getElementById("btn-agregar-reto");
    const inputReto = document.getElementById("nuevo-reto");
    
    if (btnAgregar) {
        btnAgregar.addEventListener("click", agregarReto);
    }
    
    if (inputReto) {
        inputReto.addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                agregarReto();
            }
        });
    }
}

// üîπ Inicializar retos cuando se cargue la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    inicializarRetos();
});



/// ===========================================
// CALENDARIO FINAL COMPLETO - VERSI√ìN ROBUSTA
// ===========================================

// Variables globales (compatibles con m√≥dulos y scope)
window.mesActual = new Date().getMonth();
window.a√±oActual = new Date().getFullYear();
window.hoy = new Date();
window.hoyString = `${window.hoy.getFullYear()}-${String(window.hoy.getMonth()+1).padStart(2,'0')}-${String(window.hoy.getDate()).padStart(2,'0')}`;

// ===========================================
// CARGAR EMOCIONES DESDE BD PARA CALENDARIO - VERSI√ìN ROBUSTA
// ===========================================
async function cargarCalendarioDesdeBD() {
    const token = _getToken();
    if (!token) {
        console.log('üîê No hay token - no se cargan emociones para calendario');
        return;
    }

    try {
        console.log('üîÑ Cargando emociones para calendario...');
        
        // üî• M√öLTIPLES FALLBACKS: intenta primero con apiFetch, luego con apiRequest
        let data;
        try {
            data = await apiFetch('/emociones/usuario');
        } catch (error) {
            console.warn('‚ùå apiFetch fall√≥, intentando con apiRequest...');
            data = await apiRequest('/emociones/usuario');
        }

        console.log('üìä Datos recibidos para calendario:', data);

        // üî• SINCROINZACI√ìN ROBUSTA - maneja m√∫ltiples formatos de datos
        emocion = (Array.isArray(data) ? data : []).map(r => ({
            tipo: (r.Nombre || r.nombre || r.Emocion || r.tipo || '').toString().toLowerCase().trim(),
            notas: (r.Nota || r.nota || r.Notas || r.notas || '').toString().trim(),
            fecha: (r.Fecha || r.FechaRegistro || r.fecha || r.fechaRegistro || new Date().toISOString().split('T')[0]),
            hora: (r.Hora || r.hora || (r.FechaRegistro ? new Date(r.FechaRegistro).toLocaleTimeString() : '') || new Date().toLocaleTimeString())
        }));

        console.log('üìà Total emociones cargadas para calendario:', emocion.length);

        // üî• BACKUP AUTOM√ÅTICO
        try {
            localStorage.setItem('emocionesBackup', JSON.stringify(emocion));
        } catch (e) {
            console.warn('No se pudo hacer backup de emociones');
        }

        // üî• GENERAR CALENDARIO INMEDIATAMENTE
        generarCalendario(window.mesActual, window.a√±oActual);

    } catch (err) {
        console.error('‚ùå Error cargando emociones para calendario:', err);
        // üî• FALLBACK: intenta cargar desde localStorage si todo falla
        try {
            const backupData = localStorage.getItem('emocionesBackup');
            if (backupData) {
                emocion = JSON.parse(backupData);
                console.log('üîÑ Usando datos de respaldo localStorage');
                generarCalendario(window.mesActual, window.a√±oActual);
            } else {
                console.log('üìù No hay datos de respaldo disponibles');
            }
        } catch (backupError) {
            console.error('‚ùå Fallback tambi√©n fall√≥:', backupError);
        }
    }
}

// ===========================================
// FORMATEAR FECHA / HORA - VERSI√ìN ROBUSTA
// ===========================================
function formatearFecha(fecha) {
    if (!fecha) return '';
    if (typeof fecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(fecha)) return fecha;
    
    try {
        const f = new Date(fecha);
        if (isNaN(f.getTime())) return '';
        const a = f.getFullYear();
        const m = String(f.getMonth() + 1).padStart(2,'0');
        const d = String(f.getDate()).padStart(2,'0');
        return `${a}-${m}-${d}`;
    } catch (error) {
        console.warn('Error formateando fecha:', fecha, error);
        return '';
    }
}

function formatearHora(fecha) {
    if (!fecha) return '';
    
    try {
        const f = new Date(fecha);
        if (isNaN(f.getTime())) return '';
        const h = String(f.getHours()).padStart(2,'0');
        const m = String(f.getMinutes()).padStart(2,'0');
        return `${h}:${m}`;
    } catch (error) {
        console.warn('Error formateando hora:', fecha, error);
        return '';
    }
}

function esMismoDia(fecha1, fecha2) {
    try {
        return formatearFecha(fecha1) === formatearFecha(fecha2);
    } catch (error) {
        console.warn('Error comparando fechas:', fecha1, fecha2, error);
        return false;
    }
}

// ===========================================
// GENERAR CALENDARIO - VERSI√ìN A PRUEBA DE ERRORES
// ===========================================
function generarCalendario(mes, a√±o) {
    try {
        const calendario = document.getElementById('calendario-emociones');
        const tituloMes = document.getElementById('titulo-mes');
        
        if (!calendario || !tituloMes) {
            console.error('‚ùå Elementos del calendario no encontrados');
            return;
        }

        const nombresMeses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        tituloMes.textContent = `${nombresMeses[mes]} ${a√±o}`;

        const primerDia = new Date(a√±o, mes, 1).getDay();
        const ultimoDia = new Date(a√±o, mes + 1, 0).getDate();
        const diasSemana = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];

        let html = '';
        
        // Encabezados de d√≠as
        diasSemana.forEach(d => html += `<div class="calendar-header">${d}</div>`);
        
        // D√≠as vac√≠os al inicio
        for (let i = 0; i < primerDia; i++) {
            html += `<div class="calendar-day empty"></div>`;
        }

        // üî• GENERACI√ìN ROBUSTA DE D√çAS
        for (let dia = 1; dia <= ultimoDia; dia++) {
            const diaString = `${a√±o}-${String(mes+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
            
            // üî• FILTRADO SEGURO - maneja errores en fechas
            const emocionesDia = emocion.filter(e => {
                try {
                    return esMismoDia(e.fecha, diaString);
                } catch (error) {
                    console.warn(`Error comparando fecha:`, e.fecha, error);
                    return false;
                }
            });
            
            const clases = ['calendar-day'];
            if (esMismoDia(diaString, window.hoyString)) clases.push('today');
            if (emocionesDia.length > 0) clases.push('has-emotion');

            const emocionPrincipal = emocionesDia[0];
            const tipoEmocion = (emocionPrincipal?.tipo || '').toLowerCase();
            const nota = emocionPrincipal?.notas || '';
            const icono = obtenerIconoEmocion(tipoEmocion);

            // üî• HTML SEGURO - escapa comillas en notas
            const notaSegura = nota.replace(/"/g, '&quot;');
            
            html += `
                <div class="${clases.join(' ')}" onclick="mostrarEmocionesDia(${dia}, ${mes}, ${a√±o})">
                    <div class="calendar-day-number">${dia}</div>
                    ${emocionesDia.length > 0 ? `
                        <div class="emotion-icon">${icono}</div>
                        <div class="emotion-counter">${emocionesDia.length}</div>
                        ${nota ? `<div class="emotion-note" title="${notaSegura}">${nota.slice(0,12)}${nota.length > 12 ? '‚Ä¶' : ''}</div>` : ''}
                    ` : ''}
                </div>
            `;
        }

        calendario.innerHTML = html;
        console.log('‚úÖ Calendario generado correctamente');

    } catch (error) {
        console.error('‚ùå Error cr√≠tico generando calendario:', error);
        // üî• FALLBACK: mostrar mensaje de error al usuario
        const calendario = document.getElementById('calendario-emociones');
        if (calendario) {
            calendario.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Error al cargar el calendario. Recarga la p√°gina.</div>';
        }
    }
}

// ===========================================
// ICONOS DE EMOCIONES - VERSI√ìN ROBUSTA
// ===========================================
function obtenerIconoEmocion(tipo){
    const iconos = {
        'feliz':'üòä','triste':'üò¢','enojado':'üò†','ansioso':'üò∞',
        'calmado':'üòå','energico':'üòÑ','confundido':'üòï','agradecido':'üôè'
    };
    
    if (!tipo || typeof tipo !== 'string') return '‚ùì';
    
    return iconos[tipo.toLowerCase()] || '‚ùì';
}

// ===========================================
// MODAL DEL D√çA - VERSI√ìN ROBUSTA
// ===========================================
function mostrarEmocionesDia(dia, mes, a√±o) {
    try {
        const diaString = `${a√±o}-${String(mes+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
        
        // üî• FILTRADO SEGURO
        const emocionesDia = emocion.filter(e => {
            try {
                return esMismoDia(e.fecha, diaString);
            } catch (error) {
                return false;
            }
        });
        
        if (emocionesDia.length === 0) { 
            alert(`No hay emociones registradas para el ${dia}/${mes+1}/${a√±o}`); 
            return; 
        }

        const modalHTML = `
            <div class="modal-overlay" id="modal-emociones" onclick="cerrarModal()">
                <div class="modal-container" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>Emociones del ${dia}/${mes+1}/${a√±o}</h3>
                        <button onclick="cerrarModal()" class="close-btn">√ó</button>
                    </div>
                    <div class="emociones-lista">
                        ${emocionesDia.map(emocionItem => {
                            const tipo = emocionItem.tipo || 'desconocido';
                            const notas = emocionItem.notas || '<em>Sin notas adicionales</em>';
                            const hora = emocionItem.hora || '';
                            
                            return `
                                <div class="emocion-item emotion-${tipo}">
                                    <div class="emocion-header">
                                        <span class="emocion-tipo">${obtenerIconoEmocion(tipo)} ${tipo}</span>
                                        <span class="emocion-hora">${hora}</span>
                                    </div>
                                    <div class="emocion-notas">${notas}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="cerrarModal()">Cerrar</button>
                    </div>
                </div>
            </div>
        `;
        
        const modalExistente = document.getElementById('modal-emociones'); 
        if (modalExistente) modalExistente.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
    } catch (error) {
        console.error('‚ùå Error mostrando modal:', error);
        alert('Error al mostrar las emociones del d√≠a');
    }
}

function cerrarModal(){ 
    try {
        const modal = document.getElementById('modal-emociones'); 
        if (modal) modal.remove();
    } catch (error) {
        console.error('Error cerrando modal:', error);
    }
}

// ===========================================
// INICIALIZAR CALENDARIO - CON BACKUP AUTOM√ÅTICO
// ===========================================
async function inicializarCalendario() { 
    console.log('üîÑ Inicializando calendario...');
    
    // üî• BACKUP AUTOM√ÅTICO de datos actuales
    if (emocion && emocion.length > 0) {
        try {
            localStorage.setItem('emocionesBackup', JSON.stringify(emocion));
        } catch (e) {
            console.warn('No se pudo hacer backup de emociones');
        }
    }
    
    await cargarCalendarioDesdeBD();
    
    // üî• VERIFICACI√ìN FINAL
    setTimeout(() => {
        try {
            const diasConEmociones = document.querySelectorAll('.calendar-day.has-emotion').length;
            console.log(`üìä Calendario listo. D√≠as con emociones: ${diasConEmociones}`);
        } catch (error) {
            console.log('üìä Calendario inicializado');
        }
    }, 1000);
}

// ===========================================
// CAMBIAR MES - VERSI√ìN ROBUSTA
// ===========================================
function cambiarMes(direccion){
    try {
        window.mesActual += direccion;
        if (window.mesActual < 0){ 
            window.mesActual = 11; 
            window.a√±oActual--; 
        } else if (window.mesActual > 11){ 
            window.mesActual = 0; 
            window.a√±oActual++; 
        }
        generarCalendario(window.mesActual, window.a√±oActual);
    } catch (error) {
        console.error('‚ùå Error cambiando mes:', error);
        alert('Error al cambiar de mes');
    }
}

// ===========================================
// RECARGAR CALENDARIO - VERSI√ìN ROBUSTA
// ===========================================
function recargarCalendario() {
    console.log('üîÑ Recargando calendario...');
    cargarCalendarioDesdeBD();
}

// üî• INICIALIZACI√ìN SEGURA
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que la p√°gina cargue completamente
    setTimeout(() => {
        inicializarCalendario();
    }, 500);
});

 // =============================================
// EJERCICIOS MENTALES - C√ìDIGO COMPLETO
// =============================================

// Mapeo de ejercicios a IDs de base de datos
const ejerciciosMap = {
    'respiraci√≥n': 1,      // Respiraci√≥n Profunda
    'mindfulness': 2,      // Meditaci√≥n Guiada  
    'relajaci√≥n': 3        // Relajaci√≥n Muscular
};

/**
 * Inicia un ejercicio mostrando su interfaz
 */
function iniciarEjercicio(tipo) {
    const container = document.getElementById('ejercicio-activo');
    
    console.log('üü° Iniciando ejercicio:', tipo);
    
    switch(tipo) {
        case 'respiraci√≥n':
            container.innerHTML = `
                <div class="exercise-active">
                    <h3>üßò Respiraci√≥n Consciente</h3>
                    <p>Enf√≥cate en tu respiraci√≥n durante 5 minutos</p>
                    <div class="breathing-guide">
                        <div class="breathing-step">
                            <h4>Inhala</h4>
                            <p>Por la nariz durante 4 segundos</p>
                        </div>
                        <div class="breathing-step">
                            <h4>Ret√©n</h4>
                            <p>La respiraci√≥n durante 4 segundos</p>
                        </div>
                        <div class="breathing-step">
                            <h4>Exhala</h4>
                            <p>Por la boca durante 6 segundos</p>
                        </div>
                    </div>
                    <button class="btn" onclick="completarEjercicio('respiraci√≥n')">
                        Completar Ejercicio
                    </button>
                </div>
            `;
            break;
            
         case 'gratitud':  // NUEVO CASO
            container.innerHTML = `
                <div class="exercise-active">
                    <h3>üôè Diario de Gratitud</h3>
                    <p>Escribe 3 cosas por las que est√©s agradecido hoy</p>
                    
                    <div class="gratitud-form">
                        <div class="gratitud-item">
                            <label>1. Estoy agradecido por:</label>
                            <textarea id="gratitud1" placeholder="Ej: Mi familia, mi salud..." rows="2"></textarea>
                        </div>
                        <div class="gratitud-item">
                            <label>2. Estoy agradecido por:</label>
                            <textarea id="gratitud2" placeholder="Ej: Mi trabajo, la naturaleza..." rows="2"></textarea>
                        </div>
                        <div class="gratitud-item">
                            <label>3. Estoy agradecido por:</label>
                            <textarea id="gratitud3" placeholder="Ej: Las peque√±as cosas del d√≠a..." rows="2"></textarea>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="guardarDiarioGratitud()">
                        Guardar Mi Diario
                    </button>
                </div>
            `;
            break;
            
        case 'mindfulness':
            container.innerHTML = `
                <div class="exercise-active">
                    <h3>üåø Meditaci√≥n Mindfulness</h3>
                    <p>Observa tus pensamientos sin juzgarlos durante 10 minutos</p>
                    <div class="timer">10:00</div>
                    <button class="btn" onclick="completarEjercicio('mindfulness')">
                        Completar Meditaci√≥n
                    </button>
                </div>
            `;
            break;
    }
    
    container.classList.remove('hidden');
}

/**
 * Completa un ejercicio y lo guarda en la base de datos
 */
async function completarEjercicio(tipo) {
    try {
        console.log('üöÄ Completando ejercicio:', tipo);
        
        // Verificar autenticaci√≥n
        const token = localStorage.getItem('authToken');
        if (!token) {
            alert('‚ùå Error: No est√°s autenticado. Inicia sesi√≥n nuevamente.');
            return;
        }

        // Obtener ID del ejercicio
        const idEjercicio = ejerciciosMap[tipo];
        if (!idEjercicio) {
            alert('‚ùå Error: Tipo de ejercicio no v√°lido');
            return;
        }

        console.log('üì§ Enviando a /api/ejercicios/completar:', { idEjercicio });

        // Llamar al endpoint del backend
        const response = await fetch('http://localhost:3000/api/ejercicios/completar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ 
                idEjercicio: idEjercicio 
            })
        });

        // Verificar respuesta
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Error ${response.status}`);
        }

        // Procesar respuesta exitosa
        const result = await response.json();
        console.log('‚úÖ Ejercicio guardado:', result);

        // Mostrar √©xito al usuario
        alert(`üéâ ¬°Ejercicio de ${tipo} completado!\n\nGanaste: ${result.puntosGanados} puntos\nID de sesi√≥n: ${result.idSesion}`);
        
        // Ocultar interfaz de ejercicio
        document.getElementById('ejercicio-activo').classList.add('hidden');
        
        // Actualizar estad√≠sticas locales
        const ejerciciosRealizados = parseInt(localStorage.getItem('ejerciciosRealizados') || '0') + 1;
        localStorage.setItem('ejerciciosRealizados', ejerciciosRealizados.toString());
        
        console.log('üìä Total ejercicios realizados:', ejerciciosRealizados);

        // Actualizar UI si existe la funci√≥n
        if (typeof updateProfileStats === 'function') {
            updateProfileStats();
        }

    } catch (error) {
        console.error('üí• Error completando ejercicio:', error);
        
        // Manejar errores espec√≠ficos
        let mensajeError = 'Error al guardar el ejercicio';
        
        if (error.message.includes('Failed to fetch')) {
            mensajeError = '‚ùå No se pudo conectar con el servidor. Verifica que el backend est√© ejecut√°ndose.';
        } else if (error.message.includes('401')) {
            mensajeError = '‚ùå Tu sesi√≥n ha expirado. Por favor inicia sesi√≥n nuevamente.';
        } else if (error.message.includes('404')) {
            mensajeError = '‚ùå El servidor no encontr√≥ el endpoint. Verifica la ruta.';
        } else if (error.message.includes('500')) {
            mensajeError = '‚ùå Error interno del servidor. Intenta nuevamente.';
        } else {
            mensajeError = '‚ùå ' + error.message;
        }
        
        alert(mensajeError);
    }
}

/**
 * Guarda el diario de gratitud en la base de datos
 */
async function guardarDiarioGratitud() {
    try {
        console.log('üöÄ Guardando diario de gratitud...');
        
        // Obtener los valores del formulario
        const gratitud1 = document.getElementById('gratitud1').value.trim();
        const gratitud2 = document.getElementById('gratitud2').value.trim();
        const gratitud3 = document.getElementById('gratitud3').value.trim();
        
        // Validar que todos los campos est√©n completos
        if (!gratitud1 || !gratitud2 || !gratitud3) {
            alert('‚ùå Por favor completa las 3 cosas por las que est√°s agradecido');
            return;
        }

        // Verificar autenticaci√≥n
        const token = localStorage.getItem('authToken');
        if (!token) {
            alert('‚ùå Error: No est√°s autenticado. Inicia sesi√≥n nuevamente.');
            return;
        }

        console.log('üì§ Enviando diario a /api/ejercicios/gratitud');

        // Llamar al nuevo endpoint para gratitud
        const response = await fetch('http://localhost:3000/api/ejercicios/gratitud', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ 
                gratitud1: gratitud1,
                gratitud2: gratitud2, 
                gratitud3: gratitud3
            })
        });

        // Verificar respuesta
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Error ${response.status}`);
        }

        // Procesar respuesta exitosa
        const result = await response.json();
        console.log('‚úÖ Diario de gratitud guardado:', result);

        // Mostrar √©xito al usuario
        alert(`üéâ ¬°Diario de gratitud guardado!\n\nGanaste: ${result.puntosGanados} puntos`);
        
        // Ocultar interfaz de ejercicio
        document.getElementById('ejercicio-activo').classList.add('hidden');
        
        // Actualizar estad√≠sticas locales
        const ejerciciosRealizados = parseInt(localStorage.getItem('ejerciciosRealizados') || '0') + 1;
        localStorage.setItem('ejerciciosRealizados', ejerciciosRealizados.toString());
        
        console.log('üìä Total ejercicios realizados:', ejerciciosRealizados);

        // Actualizar UI si existe la funci√≥n
        if (typeof updateProfileStats === 'function') {
            updateProfileStats();
        }

    } catch (error) {
        console.error('üí• Error guardando diario:', error);
        
        // Manejar errores espec√≠ficos
        let mensajeError = 'Error al guardar el diario';
        
        if (error.message.includes('Failed to fetch')) {
            mensajeError = '‚ùå No se pudo conectar con el servidor. Verifica que el backend est√© ejecut√°ndose.';
        } else if (error.message.includes('401')) {
            mensajeError = '‚ùå Tu sesi√≥n ha expirado. Por favor inicia sesi√≥n nuevamente.';
        } else {
            mensajeError = '‚ùå ' + error.message;
        }
        
        alert(mensajeError);
    }
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ M√≥dulo de ejercicios cargado');
    console.log('üîç Ejercicios mapeados:', ejerciciosMap);
});
    

    
    // =============================================
    // RESPIRACI√ìN DIARIA
    // =============================================

    let respiracionInterval;
    let respiracionActiva = false;
    let fase = 0; // 0: inhalar, 1: retener, 2: exhalar

    function iniciarRespiracion() {
        if (respiracionActiva) return;
        
        respiracionActiva = true;
        document.getElementById('btn-detener').classList.remove('hidden');
        
        const circulo = document.getElementById('circulo-respiracion');
        const instruccion = document.getElementById('instruccion-respiracion');
        
        respiracionInterval = setInterval(() => {
            switch(fase) {
                case 0: // Inhalar
                    circulo.textContent = 'INHALA';
                    circulo.style.transform = 'scale(1.2)';
                    instruccion.textContent = 'Inhala profundamente por la nariz (4 segundos)';
                    setTimeout(() => fase = 1, 4000);
                    break;
                case 1: // Retener
                    circulo.textContent = 'RET√âN';
                    instruccion.textContent = 'Ret√©n la respiraci√≥n (4 segundos)';
                    setTimeout(() => fase = 2, 4000);
                    break;
                case 2: // Exhalar
                    circulo.textContent = 'EXHALA';
                    circulo.style.transform = 'scale(1)';
                    instruccion.textContent = 'Exhala lentamente por la boca (6 segundos)';
                    setTimeout(() => fase = 0, 6000);
                    break;
            }
            fase = (fase + 1) % 3;
        }, 14000); // Ciclo completo: 4 + 4 + 6 = 14 segundos
    }

    function detenerRespiracion() {
        respiracionActiva = false;
        clearInterval(respiracionInterval);
        document.getElementById('btn-detener').classList.add('hidden');
        
        const circulo = document.getElementById('circulo-respiracion');
        const instruccion = document.getElementById('instruccion-respiracion');
        
        circulo.textContent = 'INHALA';
        circulo.style.transform = 'scale(1)';
        instruccion.textContent = 'Inhala profundamente por la nariz';
        
        // Registrar sesi√≥n completada
        const sesiones = parseInt(localStorage.getItem('sesionesRespiracion') || '0') + 1;
        localStorage.setItem('sesionesRespiracion', sesiones.toString());
        document.getElementById('sesiones-completadas').textContent = sesiones;
        
        // Actualizar d√≠as consecutivos (simulado)
        const dias = parseInt(localStorage.getItem('diasConsecutivos') || '0') + 1;
        localStorage.setItem('diasConsecutivos', dias.toString());
        document.getElementById('dias-consecutivos').textContent = dias;
    }

  
// =============================================
// MASCOTA VIRTUAL - CONEXI√ìN COMPLETA CON BASE DE DATOS
// =============================================
function actualizarInterfazMascota() {
    limpiarMediosMascota(); // üßπ evita que se traben los medios

    const contenedor = document.getElementById('mascota-display');
    contenedor.innerHTML = `<img src="${mascotaMedia[mascota.tipo].imagen}" class="imagen-base">`;
}


// Datos de la mascota (se llenar√°n desde la BD)
const mascota = {
    idUsuarioMascota: null,
    idUsuario: 10, // ID del usuario actual (Angie)
    idMascota: null,
    tipo: '',
    apodo: '',
    nivel: 1,
    experiencia: 0,
    experienciaNecesaria: 100,
    monedas: 50,
    felicidad: 50,
    energia: 100,
    hambre: 0,
    estado: 'Feliz',
    mensaje: '¬°Selecciona tu mascota para comenzar!',
    seleccionada: false
};

// üî• NUEVO: Control para evitar videos duplicados
let videoEnReproduccion = false;
let ultimoNivelMostrado = 0;

// URLs de im√°genes/videos para cada mascota
const mascotaMedia = {
    'axolote': {
        imagen: 'imagvideos/axolo.png',
        video: 'imagvideos/axolotefeliz.mp4',
        comiendo: 'imagvideos/axolotecomiendo.gif',
        acariciando: 'imagvideos/axoloteacariciando.gif',
        descansando: 'imagvideos/axolotedurmiendo.gif',
        feliz: 'imagvideos/axolote-feliz.gif',
        // üî• NUEVO: Video de subida de nivel
        subidaNivel: 'imagvideos/axolotenivel.mp4',
        jugando: {
            pelota: 'imagvideos/axolotepelota.gif',
            cuerda: 'imagvideos/axolotecuerda.gif',
            pluma: 'imagvideos/axolotehappy.gif',
            escondite: 'imagvideos/axoloteescondite.gif'
        }
    },
    'dinosaurio': {
        imagen: 'imagvideos/dinosau.png',
        video: 'imagvideos/dino.mp4',
        comiendo: 'imagvideos/dinocomiendo.gif',
        acariciando: 'imagvideos/dinoacarieciando.png',
        descansando: 'imagvideos/dinodormir.gif',
        feliz: 'imagvideos/dino-feliz.gif',
        // üî• NUEVO: Video de subida de nivel
        subidaNivel: 'imagvideos/dinonivel.mp4',
        jugando: {
            pelota: 'imagvideos/dinopelota.gif',
            cuerda: 'imagvideos/dinocuerda.gif',
            pluma: 'imagvideos/dinoplumita.gif',
            escondite: 'imagvideos/dinoescondite.gif'
        }
    },
    'caracol': {
        imagen: 'imagvideos/caracoli.png',
        video: 'imagvideos/caracol.mp4',
        comiendo: 'imagvideos/caracolcomiendo.gif',
        acariciando: 'imagvideos/caracolacariciando.gif',
        descansando: 'imagvideos/caracoldurmiendo.gif',
        feliz: 'imagvideos/caracol-feliz.gif',                                                                                                                                                                                                                                                                                                                                                                            
        // üî• NUEVO: Video de subida de nivel
        subidaNivel: 'imagvideos/caracolnivel.mp4',
        jugando: {
            pelota: 'imagvideos/caracoljugando.gif',
            cuerda: 'imagvideos/caracolcuerda.gif',
            pluma: 'imagvideos/caracolpluma.gif',
            escondite: 'imagvideos/caracolescondiendo.gif'
        }
    }
};

// Mensajes positivos
const mensajesPositivos = {
    alimentar: [
        "¬°Yupi! ¬°Qu√© rico! Eres el mejor due√±o del mundo üåü",
        "¬°Mmm, delicioso! Me encanta cuando me alimentas üíñ",
        "¬°Wow! Esta comida es incre√≠ble, ¬°gracias! ü•∞",
        "¬°Eres incre√≠ble! Siempre sabes lo que me gusta ‚ú®",
        "¬°Qu√© bien me siento! Me das la mejor comida üéâ"
    ],
    acariciar: [
        "¬°Ahh, qu√© rico! Tus caricias son las mejores ü•∞",
        "¬°Me encanta cuando me acaricias! Eres tan bueno conmigo üíñ",
        "¬°Purrr! Me haces tan feliz con tus mimos ‚ú®",
        "¬°Eres el mejor! Nadie me acaricia como t√∫ üåü",
        "¬°Qu√© bien me siento! Tus manos son m√°gicas üí´"
    ],
    descansar: [
        "Zzz... ¬°Qu√© bien descanso contigo! Eres mi lugar seguro üåô",
        "¬°Me siento renovado! Gracias por dejarme descansar üí§",
        "¬°Qu√© sue√±o m√°s reparador! Contigo todo es mejor üåü",
        "Zzz... Me encanta dormir a tu lado, me siento protegido üíñ",
        "¬°Descans√© divinamente! Eres mi compa√±ero ideal ü•∞"
    ],
    jugar: {
        pelota: [
            "¬°Yay! ¬°Me encanta perseguir la pelota! üéæ",
            "¬°Qu√© divertido! Atrapa la pelota contigo es lo mejor üåü",
            "¬°Eres el mejor lanzador de pelotas! ü•é",
            "¬°Esta pelota es incre√≠ble! Juguemos m√°s tiempo üíñ"
        ],
        cuerda: [
            "¬°Jalar la cuerda es mi juego favorito! ü™¢",
            "¬°Eres muy fuerte! Pero yo soy m√°s fuerte üí™",
            "¬°Qu√© emoci√≥n! La cuerda es lo m√°s divertido ‚ú®",
            "¬°No puedo soltar la cuerda! Es muy divertido ü•∞"
        ],
        pluma: [
            "¬°Las plumas son tan graciosas! Me hacen cosquillas ü™∂",
            "¬°Perseguir plumas es lo m√°s divertido del mundo! üí´",
            "¬°Qu√© pluma tan juguetona! No puedo dejar de perseguirla üåü",
            "¬°Las plumas me vuelven loco de felicidad! ü•≥"
        ],
        escondite: [
            "¬°Encontrarte fue tan emocionante! üéØ",
            "¬°Eres el mejor escondi√©ndote! Pero yo soy mejor buscando üîç",
            "¬°Qu√© divertido jugar al escondite contigo! üèÉ‚Äç‚ôÇÔ∏è",
            "¬°Encontrarte me hace tan feliz! Juguemos otra vez üíï"
        ]
    }
};

// =============================================
// üî• FUNCI√ìN GENERAL 
// =============================================

async function apiCall(endpoint, options = {}) {
    const token = localStorage.getItem("authToken"); // token correcto

    const config = {
        method: options.method || "GET",
        headers: {
            "Content-Type": "application/json",
        },
    };

    // üî• SI HAY TOKEN ‚Üí SE ENV√çA CORRECTAMENTE
    if (token) {
        config.headers["Authorization"] = "Bearer " + token;
        console.log("üîê Token enviado:", token);
    } else {
        console.warn("‚ùå NO HAY TOKEN EN LOCALSTORAGE");
    }

    // Si hay body ‚Üí se a√±ade
    if (options.body) {
        config.body = typeof options.body === "string"
            ? options.body
            : JSON.stringify(options.body);
    }

    try {
        const response = await fetch(endpoint, config);

        if (!response.ok) {
            console.warn("‚ö† Error API:", response.status, endpoint);
            return null;
        }

        return await response.json();

    } catch (error) {
        console.warn("‚ö† No hay conexi√≥n con backend (offline)");
        return null;
    }
}


// =============================================
// üî• CARGAR MASCOTA EXISTENTE + SISTEMA DE VIDEOS DE NIVEL
// =============================================

async function cargarMascotaExistente() {
    console.log("üì• Cargando mascota desde: /api/mascota/actual");

    const data = await apiCall(`/api/mascota/actual`);

    if (data && data.IdUsuarioMascota) {
        console.log("üêæ Mascota encontrada en BD:", data);

        // üî• NUEVO: Guardar nivel anterior para detectar subidas
        const nivelAnterior = mascota.nivel || 1;
        
        mascota.idUsuarioMascota = data.IdUsuarioMascota;
        mascota.tipo = data.Tipo;
        mascota.nivel = data.Nivel;
        mascota.experiencia = data.Experiencia;
        mascota.experienciaNecesaria = data.ExperienciaNecesaria;
        mascota.felicidad = data.Felicidad;
        mascota.energia = data.Energia;
        mascota.hambre = data.Hambre;
        mascota.monedas = data.Monedas;
        mascota.estado = data.Estado;
        mascota.seleccionada = true;

        actualizarInterfazMascota();
        actualizarFeedMascotaSeleccionada();
        
        // üî• NUEVO: Verificar si subi√≥ de nivel y mostrar video
        if (mascota.nivel > nivelAnterior && mascota.nivel > ultimoNivelMostrado) {
            console.log(`üéâ ¬°${mascota.tipo} subi√≥ al nivel ${mascota.nivel}!`);
            setTimeout(() => {
                mostrarVideoSubidaNivel(mascota.nivel, mascota.tipo);
            }, 2000);
        }
    } 
    else {
        console.warn("‚ö† No existe mascota activa en BD. Usuario debe seleccionar una.");

        mascota.seleccionada = false;
        mascota.idUsuarioMascota = null;
        mascota.tipo = "";
        
        // Asegurar que se muestre el selector
        const selectorContainer = document.querySelector('.mascota-seleccion-container');
        const activaContainer = document.getElementById('mascota-activa-container');
        
        if (selectorContainer) selectorContainer.style.display = 'block';
        if (activaContainer) activaContainer.style.display = 'none';
    }
}

// üî• NUEVO: FUNCI√ìN PARA MOSTRAR VIDEO DE SUBIDA DE NIVEL
function mostrarVideoSubidaNivel(nivel, tipoMascota) {
    // Evitar m√∫ltiples videos simult√°neos
    if (videoEnReproduccion) {
        console.log("‚ö†Ô∏è Ya hay un video en reproducci√≥n, esperando...");
        return;
    }
    
    const videoUrl = mascotaMedia[tipoMascota]?.subidaNivel;
    
    if (!videoUrl) {
        console.warn(`‚ùå No hay video de subida de nivel para: ${tipoMascota}`);
        // Mostrar mensaje de felicitaci√≥n alternativo
        mostrarMensajeNivel(nivel, tipoMascota);
        return;
    }
    
    console.log(`üé¨ Reproduciendo video de subida de nivel para ${tipoMascota} nivel ${nivel}`);
    videoEnReproduccion = true;
    ultimoNivelMostrado = nivel;
    
    // Crear modal para el video
    const modalHTML = `
        <div id="modal-video-nivel" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:10000;">
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:15px; overflow:hidden; max-width:600px; width:90%; position:relative; box-shadow:0 0 30px rgba(255,255,255,0.3);">
                <div style="position:absolute; top:15px; right:15px; z-index:10001;">
                    <button onclick="cerrarVideoSubidaNivel()" style="background:rgba(255,255,255,0.3); color:white; border:none; border-radius:50%; width:35px; height:35px; font-size:18px; cursor:pointer; backdrop-filter:blur(10px);">√ó</button>
                </div>
                <div style="padding:1.5rem; text-align:center; color:white;">
                    <h2 style="margin:0 0 0.5rem 0; font-size:1.8rem;">üéâ ¬°Felicidades!</h2>
                    <p style="margin:0; font-size:1.1rem; opacity:0.9;">Tu ${tipoMascota} alcanz√≥ el nivel ${nivel}</p>
                </div>
                <video id="video-subida-nivel" autoplay muted style="width:100%; height:auto; max-height:400px; display:block; background:#000;">
                    <source src="${videoUrl}" type="video/mp4">
                    Tu navegador no soporta el elemento video.
                </video>
                <div style="padding:1rem; text-align:center; background:rgba(255,255,255,0.1);">
                    <p style="margin:0; color:white; font-size:0.9rem; opacity:0.8;">¬°Sigue as√≠! Tu mascota est√° muy feliz contigo</p>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente si hay uno
    const modalExistente = document.getElementById('modal-video-nivel');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Reproducir video autom√°ticamente
    const video = document.getElementById('video-subida-nivel');
    if (video) {
        video.play().then(() => {
            console.log("‚úÖ Video de subida de nivel reproduci√©ndose");
        }).catch(e => {
            console.log("‚ùå Error reproduciendo video:", e);
            // Si falla el video, mostrar mensaje alternativo
            mostrarMensajeNivel(nivel, tipoMascota);
            cerrarVideoSubidaNivel();
        });
        
        // Cerrar autom√°ticamente cuando termine el video
        video.addEventListener('ended', function() {
            console.log("‚úÖ Video terminado, cerrando...");
            setTimeout(cerrarVideoSubidaNivel, 1000);
        });
        
        // Tambi√©n permitir cerrar con Escape
        document.addEventListener('keydown', function closeOnEscape(e) {
            if (e.key === 'Escape') {
                cerrarVideoSubidaNivel();
                document.removeEventListener('keydown', closeOnEscape);
            }
        });
    }
}

// üî• NUEVO: FUNCI√ìN PARA CERRAR EL VIDEO DE SUBIDA DE NIVEL
function cerrarVideoSubidaNivel() {
    const modal = document.getElementById('modal-video-nivel');
    if (modal) {
        const video = document.getElementById('video-subida-nivel');
        if (video) {
            video.pause();
            video.currentTime = 0;
        }
        modal.remove();
        videoEnReproduccion = false;
        console.log("‚úÖ Video de subida de nivel cerrado");
    }
}

// üî• NUEVO: FUNCI√ìN ALTERNATIVA SI NO HAY VIDEO
function mostrarMensajeNivel(nivel, tipoMascota) {
    console.log(`üéâ Mostrando mensaje de nivel ${nivel} para ${tipoMascota}`);
    
    const mensajeHTML = `
        <div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:2rem; border-radius:15px; text-align:center; z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            <h2 style="margin:0 0 1rem 0; font-size:2rem;">üéâ ¬°Nivel ${nivel}!</h2>
            <p style="margin:0 0 1rem 0; font-size:1.2rem;">Tu ${tipoMascota} ha subido de nivel</p>
            <button onclick="this.parentElement.remove()" style="background:white; color:#764ba2; border:none; padding:0.5rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:bold;">
                ¬°Genial!
            </button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', mensajeHTML);
    
    // Auto-cerrar despu√©s de 3 segundos
    setTimeout(() => {
        const mensaje = document.querySelector('div[style*="background:linear-gradient(135deg, #667eea"]');
        if (mensaje) mensaje.remove();
    }, 3000);
}

// üî• NUEVO: ACTUALIZAR FUNCI√ìN ganarExperiencia PARA INCLUIR VIDEO
function ganarExperiencia(cantidad) {
    if (!mascota.seleccionada) return;
    
    const nivelAnterior = mascota.nivel;
    
    mascota.experiencia += cantidad;
    
    // Verificar subida de nivel
    let nivelesSubidos = 0;
    while (mascota.experiencia >= mascota.experienciaNecesaria) {
        mascota.experiencia -= mascota.experienciaNecesaria;
        mascota.nivel++;
        nivelesSubidos++;
        mascota.experienciaNecesaria = Math.floor(mascota.experienciaNecesaria * 1.5);
        
        console.log(`üéâ ¬°${mascota.tipo} subi√≥ al nivel ${mascota.nivel}!`);
    }
    
    // üî• MOSTRAR VIDEO SI SUBI√ì DE NIVEL
    if (nivelesSubidos > 0 && mascota.nivel > ultimoNivelMostrado) {
        console.log(`üìà Subi√≥ ${nivelesSubidos} nivel(es), mostrando video...`);
        setTimeout(() => {
            mostrarVideoSubidaNivel(mascota.nivel, mascota.tipo);
        }, 1000);
    }
    
    actualizarInterfazMascota();
    guardarMascota();
}

// üî• NUEVO: FUNCI√ìN DE TEST PARA PROBAR VIDEOS
function testVideoSubidaNivel(tipoMascota = "axolote", nivel = 5) {
    console.log(`üß™ Test: Mostrando video de subida de nivel para ${tipoMascota}`);
    mostrarVideoSubidaNivel(nivel, tipoMascota);
}


// =============================================
// üî• DETECTOR AUTOM√ÅTICO DE CAMBIO DE USUARIO + DETECCI√ìN USUARIO NUEVO
// =============================================

let usuarioActualId = null;
let usuarioVerificado = false; // üî• NUEVO: Para controlar verificaci√≥n de mascota

// Funci√≥n para limpiar cache de mascota (USA TU resetearMascota)
function limpiarCacheMascota() {
    console.log('üßπ Limpiando cache de mascota...');
    
    // ‚úÖ USAR TU FUNCI√ìN EXISTENTE resetearMascota
    resetearMascota();
    
    // Mostrar selector de mascotas
    const selectorContainer = document.querySelector('.mascota-seleccion-container');
    const activaContainer = document.getElementById('mascota-activa-container');
    
    if (selectorContainer) selectorContainer.style.display = 'block';
    if (activaContainer) activaContainer.style.display = 'none';
    
    // ‚úÖ USAR TU FUNCI√ìN EXISTENTE actualizarFeedMascotaSeleccionada
    actualizarFeedMascotaSeleccionada();
    
    console.log('‚úÖ Cache de mascota limpiado');
}

// üî• NUEVA: Funci√≥n para forzar actualizaci√≥n despu√©s del login
function forzarActualizacionMascota() {
    console.log('üîÑ Forzando actualizaci√≥n de mascota...');
    usuarioActualId = null; // Resetear para forzar detecci√≥n
    usuarioVerificado = false; // üî• Resetear verificaci√≥n
    detectarCambioUsuario();
}

// üî• NUEVA: Verificar si usuario es nuevo (sin mascota)
async function verificarUsuarioNuevo(userId) {
    try {
        console.log("üîç Verificando si usuario es nuevo...", userId);
        
        // Verificar si ya tiene mascota en la base de datos
        const mascotasData = await apiRequest(`/api/mascotas/usuario/${userId}`);
        const tieneMascota = mascotasData && Array.isArray(mascotasData) && mascotasData.length > 0;
        
        console.log("üìä Usuario tiene mascota:", tieneMascota);
        
        if (!tieneMascota) {
            console.log("üÜï USUARIO NUEVO DETECTADO - Sin mascota asignada");
            
            // Esperar un poco para que cargue la interfaz principal
            setTimeout(() => {
                mostrarModalBienvenidaMascota();
            }, 2000);
        } else {
            console.log("‚úÖ Usuario existente - Ya tiene mascota");
        }
        
        usuarioVerificado = true; // üî• Marcar como verificado
        
    } catch (error) {
        console.log("‚ö†Ô∏è Error verificando usuario nuevo:", error);
        usuarioVerificado = true; // üî• En caso de error, marcar como verificado para no repetir
    }
}

// üî• NUEVA: Modal de bienvenida para selecci√≥n de mascota
function mostrarModalBienvenidaMascota() {
    // Evitar m√∫ltiples modales
    if (document.getElementById('modal-bienvenida-mascota')) return;
    
    console.log("üéÆ Mostrando modal de bienvenida para selecci√≥n de mascota");
    
    const modalHTML = `
        <div id="modal-bienvenida-mascota" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:10000;">
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:2.5rem; border-radius:20px; max-width:500px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,0.3); color:white;">
                <div style="font-size:4rem; margin-bottom:1rem;">üêæ</div>
                <h2 style="margin-bottom:1rem; font-size:1.8rem;">¬°Elige tu Compa√±ero!</h2>
                <p style="margin-bottom:2rem; line-height:1.6; font-size:1.1rem;">
                    Para comenzar tu aventura, selecciona una mascota virtual que te acompa√±ar√° y motivar√° en tu journey de bienestar.
                </p>
                <div style="display:flex; gap:1rem; justify-content:center;">
                    <button onclick="cerrarModalBienvenida()" style="padding:0.8rem 1.5rem; border:2px solid white; background:transparent; color:white; border-radius:10px; cursor:pointer; font-weight:bold;">
                        Despu√©s
                    </button>
                    <button onclick="irASeleccionMascota()" style="padding:0.8rem 1.5rem; background:white; color:#764ba2; border:none; border-radius:10px; cursor:pointer; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.2);">
                        ¬°Elegir Mascota!
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function cerrarModalBienvenida() {
    const modal = document.getElementById('modal-bienvenida-mascota');
    if (modal) {
        modal.remove();
        console.log("‚ùå Modal de bienvenida cerrado");
    }
}

function irASeleccionMascota() {
    const modal = document.getElementById('modal-bienvenida-mascota');
    if (modal) modal.remove();
    
    console.log("üéØ Navegando a selecci√≥n de mascota...");
    
    // Navegar a la secci√≥n de mascotas
    showSection('mascotas');
    
    // Forzar recarga limpia de mascotas
    setTimeout(() => {
        if (typeof cargarMascotas === 'function') {
            cargarMascotas();
        }
        if (typeof mostrarModalMascotas === 'function') {
            mostrarModalMascotas();
        }
        
        console.log("‚úÖ Selecci√≥n de mascota lista");
    }, 500);
}

// Detectar cambio de usuario autom√°ticamente
function detectarCambioUsuario() {
    const token = localStorage.getItem("authToken");
    
    if (!token) {
        // No hay usuario logeado
        if (usuarioActualId !== null) {
            console.log('üö™ Usuario cerr√≥ sesi√≥n');
            usuarioActualId = null;
            usuarioVerificado = false; // üî• Resetear verificaci√≥n
            limpiarCacheMascota();
        }
        return;
    }

    // Decodificar el token para obtener el userId
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const nuevoUsuarioId = payload.userId;

        // Si el usuario cambi√≥
        if (nuevoUsuarioId !== usuarioActualId) {
            console.log(`üîÑ Cambio detectado: Usuario ${usuarioActualId} -> ${nuevoUsuarioId}`);
            usuarioActualId = nuevoUsuarioId;
            usuarioVerificado = false; // üî• Nueva verificaci√≥n necesaria
            
            // Limpiar cache y cargar nueva mascota
            limpiarCacheMascota();
            setTimeout(() => {
                // ‚úÖ USAR TU FUNCI√ìN EXISTENTE cargarMascotaExistente
                cargarMascotaExistente();
                
                // üî• VERIFICAR SI ES USUARIO NUEVO DESPU√âS DE CARGAR MASCOTA
                setTimeout(() => {
                    if (!usuarioVerificado) {
                        verificarUsuarioNuevo(nuevoUsuarioId);
                    }
                }, 1500);
            }, 100);
        } else if (!usuarioVerificado) {
            // üî• Mismo usuario pero a√∫n no verificado (primera carga)
            console.log("üîç Verificando usuario existente...");
            verificarUsuarioNuevo(nuevoUsuarioId);
        }
    } catch (error) {
        console.error('‚ùå Error decodificando token:', error);
    }
}

// Inicializar el detector
function inicializarDetectorUsuario() {
    console.log('üîç Iniciando detector de cambios de usuario...');
    
    // Verificar inmediatamente al cargar
    detectarCambioUsuario();
    
    // Verificar cada segundo
    setInterval(detectarCambioUsuario, 1000);
}

// üî• NUEVA: Funci√≥n para actualizar usuario actual manualmente
function actualizarUsuarioActual() {
    console.log('üë§ Actualizando usuario actual manualmente...');
    const token = localStorage.getItem("authToken");
    
    if (token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const userId = payload.userId;
            
            // Actualizar el ID en el objeto mascota
            mascota.idUsuario = userId;
            console.log(`‚úÖ Usuario actualizado: ${userId}`);
            
        } catch (error) {
            console.error('‚ùå Error obteniendo usuario del token:', error);
        }
    }
}

// üî• NUEVA: Funci√≥n para marcar usuario como verificado (cuando selecciona mascota)
function marcarUsuarioVerificado() {
    usuarioVerificado = true;
    console.log("‚úÖ Usuario marcado como verificado (tiene mascota)");
}
// =============================================
// üî• GUARDAR ESTADO DE MASCOTA
// =============================================
async function guardarEstadoMascota() {
    if (!mascota.seleccionada || !mascota.idUsuarioMascota) return;

    const payload = {
        IdUsuarioMascota: mascota.idUsuarioMascota,
        Nivel: mascota.nivel,
        Experiencia: mascota.experiencia,
        ExperienciaNecesaria: mascota.experienciaNecesaria,
        Felicidad: mascota.felicidad,
        Energia: mascota.energia,
        Hambre: mascota.hambre,
        Monedas: mascota.monedas,
        Estado: mascota.estado
    };

    const result = await apiCall("/api/mascota/actualizar", {
        method: "PUT",
        body: JSON.stringify(payload)
    });

    if (result?.ok) {
        console.log("üíæ Mascota guardada en BD");
    } else {
        console.warn("‚ö† Guardado en modo offline");
    }
}



// üî• FUNCI√ìN MEJORADA: Seleccionar mascota (CON REUTILIZACI√ìN)
async function seleccionarMascota(tipo) {
    console.log("üéØ Seleccionando/Reactivando mascota:", tipo);

    const data = await apiCall("/api/mascota/seleccionar", {
        method: "POST",
        body: JSON.stringify({ Tipo: tipo })
    });

    if (!data || !data.IdUsuarioMascota) {
        console.error("‚ùå No se pudo seleccionar mascota");
        return;
    }

    console.log("üêæ Mascota seleccionada/reactivada:", data);

    // Actualizar objeto mascota local
    Object.assign(mascota, {
        idUsuarioMascota: data.IdUsuarioMascota,
        tipo: data.Tipo,
        nivel: data.Nivel,
        experiencia: data.Experiencia,
        experienciaNecesaria: data.ExperienciaNecesaria,
        felicidad: data.Felicidad,
        energia: data.Energia,
        hambre: data.Hambre,
        monedas: data.Monedas,
        estado: data.Estado,
        seleccionada: true
    });

    actualizarInterfazMascota();
    actualizarFeedMascotaSeleccionada();
    
// Mostrar mensaje informativo SOLO cuando regresa despu√©s de tiempo
if (data.FechaAdopcion) {
    const hoy = new Date();
    const fechaAdopcion = new Date(data.FechaAdopcion);
    const diffTime = Math.abs(hoy - fechaAdopcion);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    // Obtener √∫ltima interacci√≥n del localStorage o usar fecha de adopci√≥n
    const ultimaInteraccion = localStorage.getItem('ultimaInteraccionMascota');
    const ultimaFecha = ultimaInteraccion ? new Date(ultimaInteraccion) : fechaAdopcion;
    
    const tiempoSinConectar = Math.abs(hoy - ultimaFecha);
    const horasSinConectar = Math.ceil(tiempoSinConectar / (1000 * 60 * 60));
    
    // Solo mostrar mensaje si pas√≥ m√°s de 1 hora sin conectarse
    if (horasSinConectar > 1) {
        if (diffDays > 1) {
            mascota.mensaje = `¬°Te extra√±√© mucho! No te hab√≠a visto en ${diffDays} d√≠as üíñ`;
        } else {
            mascota.mensaje = `¬°Te extra√±√© mucho! No te hab√≠a visto en ${horasSinConectar} horas üíñ`;
        }
        actualizarMascota();
    }
    
    // Guardar que YA interactu√≥ hoy
    localStorage.setItem('ultimaInteraccionMascota', hoy.toISOString());
}
}


// ‚úÖ FUNCI√ìN CORREGIDA DE VALIDACI√ìN
function validarMascotaSeleccionada(mascotaObj) {
    const valida = mascotaObj && 
           mascotaObj.idUsuarioMascota !== null &&
           mascotaObj.idUsuarioMascota !== undefined &&
           mascotaObj.idUsuarioMascota !== 0 && // ‚Üê A√ëADIDO: tambi√©n verificar que no sea 0
           mascotaObj.tipo && 
           mascotaObj.tipo !== '' &&
          
           mascotaObj.seleccionada === true;
    
    console.log('üîç Validaci√≥n mascota:', {
        objeto: mascotaObj,
        idUsuarioMascota: mascotaObj?.idUsuarioMascota,
        tipo: mascotaObj?.tipo,
       
        seleccionada: mascotaObj?.seleccionada,
        resultado: valida
    });
    
    return valida;
}

// ‚úÖ FUNCI√ìN CORREGIDA PARA RESETEAR MASCOTA
function resetearMascota() {
    console.log('üîÑ Reseteando mascota...');
    mascota.seleccionada = false;
    mascota.idUsuarioMascota = null;
    mascota.idMascota = null; // ‚Üê A√ëADIDO
    mascota.tipo = '';
   
    mascota.estado = 'normal';
    mascota.mensaje = '¬°Selecciona una mascota para comenzar!';
    // ... otros campos que necesites resetear
    
    actualizarInterfazMascota();
}



// =====================================================
// üé® NUEVO: OCULTAR TARJETAS SI YA TIENE MASCOTA
// =====================================================
function actualizarFeedMascotaSeleccionada() {
    console.log("üé® Ajustando feed visual seg√∫n mascota seleccionada...");

    const tarjetas = document.querySelectorAll('.pet-option-card');

    if (mascota.seleccionada && mascota.tipo) {
        tarjetas.forEach(card => {
            const tipoCard = card.getAttribute('data-pet');

            if (tipoCard !== mascota.tipo) {
                card.style.display = "none";        // üî• OCULTA LAS OTRAS MASCOTAS
            } else {
                card.style.display = "flex";
                card.classList.add("selected");    // üîµ MARCA LA DEL USUARIO
            }
        });
    } else {
        tarjetas.forEach(card => {
            card.style.display = "flex";
            card.classList.remove("selected");
        });
    }
}

// =============================================
// FUNCIONES PRINCIPALES DE LA MASCOTA
// =============================================

// üî• FUNCI√ìN PARA OBTENER MENSAJES POSITIVOS
function obtenerMensajePositivo(tipo, juego = null) {
    if (tipo === 'jugar' && juego) {
        const mensajes = mensajesPositivos.jugar[juego];
        return mensajes[Math.floor(Math.random() * mensajes.length)];
    }
    const mensajes = mensajesPositivos[tipo];
    return mensajes[Math.floor(Math.random() * mensajes.length)];
}



// üî• FUNCI√ìN MEJORADA: Alimentar mascota CON BD
async function alimentarMascota(comida) {
    if (!mascota.seleccionada) {
        mascota.mensaje = "¬°Primero selecciona una mascota para alimentar! üêæ";
        actualizarMascota();
        return;
    }
    
    const costos = {
        'zanahoria': 2,
        'manzana': 3,
        'pescado': 4,
        'carne': 5
    };
    
    const beneficios = {
        'zanahoria': { hambre: -15, felicidad: 5, energia: 2 },
        'manzana': { hambre: -20, felicidad: 8, energia: 3 },
        'pescado': { hambre: -25, felicidad: 10, energia: 4 },
        'carne': { hambre: -30, felicidad: 12, energia: 5 }
    };
    
    const costo = costos[comida];
    
    if (mascota.monedas < costo) {
        mascota.mensaje = "No tengo suficientes monedas. ¬°Juguemos para ganar m√°s! üí∞";
        actualizarMascota();
        return;
    }
    
    const beneficio = beneficios[comida];
    
    // APLICAR BENEFICIOS
    mascota.hambre = Math.max(0, mascota.hambre + beneficio.hambre);
    mascota.felicidad = Math.min(100, mascota.felicidad + beneficio.felicidad);
    mascota.energia = Math.min(100, Math.max(0, mascota.energia + beneficio.energia));
    mascota.monedas -= costo;
    mascota.experiencia += 10;
    
    const mensajesComida = {
        'zanahoria': '¬°√ëam √±am! Las zanahorias son deliciosas ü•ï',
        'manzana': '¬°Qu√© manzana m√°s jugosa! üçé',
        'pescado': '¬°El pescado est√° fresqu√≠simo! üêü',
        'carne': '¬°Esta carne me da mucha energ√≠a! üçñ'
    };
    
    mascota.mensaje = mensajesComida[comida] || '¬°Gracias por la comida! üòã';
    mascota.estado = 'comiendo';
    
    // MOSTRAR GIF DE COMER
    mostrarGifAccion('comiendo');
    
    actualizarMascota();
    
    // GUARDAR EN BD
    await guardarEstadoMascota();

    
    verificarSubidaNivelMascota();
    
    setTimeout(() => {
        mascota.estado = 'normal';
        restaurarVideoNormal();
        if (mascota.hambre <= 20) {
            mascota.mensaje = '¬°Estoy lleno y feliz! ü•∞';
        } else {
            mascota.mensaje = '¬°Qu√© rico! ¬øHay algo m√°s? üòä';
        }
        actualizarMascota();
    }, 3000);
}
function alimentar() {
    limpiarMediosMascota(); // üßπ limpiar antes

    const contenedor = document.getElementById('mascota-display');
    contenedor.innerHTML = `<img src="${mascotaMedia[mascota.tipo].comiendo}" class="animacion-mascota">`;

    ganarExperiencia(10);
}


// üî• FUNCI√ìN MEJORADA: Acariciar mascota CON BD
async function acariciarMascota() {
    if (!mascota.seleccionada) {
        mascota.mensaje = "¬°Selecciona una mascota para acariciar! ‚ù§Ô∏è";
        actualizarMascota();
        return;
    }
    
    mascota.felicidad = Math.min(100, mascota.felicidad + 8);
    mascota.energia = Math.max(0, mascota.energia - 2);
    mascota.experiencia += 5;
    
    mascota.mensaje = obtenerMensajePositivo('acariciar');
    mascota.estado = 'acariciando';
    
    // MOSTRAR GIF DE ACARICIAR
    mostrarGifAccion('acariciando');
    
    actualizarMascota();
    
    // GUARDAR EN BD
    await guardarEstadoMascota();
    
    
    verificarSubidaNivelMascota();
    
    setTimeout(() => {
        mascota.estado = 'normal';
        restaurarVideoNormal();
        actualizarMascota();
    }, 2000);
}
function acariciar() {
    limpiarMediosMascota();

    const contenedor = document.getElementById('mascota-display');
    contenedor.innerHTML = `<img src="${mascotaMedia[mascota.tipo].acariciando}" class="animacion-mascota">`;

    ganarExperiencia(5);
}


// üî• FUNCI√ìN MEJORADA: Descansar mascota CON BD
async function descansarMascota() {
    if (!mascota.seleccionada) {
        mascota.mensaje = "¬°Selecciona una mascota para que descanse! üåô";
        actualizarMascota();
        return;
    }
    
    if (mascota.energia >= 90) {
        mascota.mensaje = "¬°Estoy lleno de energ√≠a! Prefiero jugar contigo ‚ö°";
        actualizarMascota();
        return;
    }
    
    mascota.energia = Math.min(100, mascota.energia + 30);
    mascota.felicidad = Math.min(100, mascota.felicidad + 5);
    mascota.experiencia += 8;
    
    mascota.mensaje = obtenerMensajePositivo('descansar');
    mascota.estado = 'descansando';
    
    // MOSTRAR GIF DE DESCANSAR
    mostrarGifAccion('descansando');
    
    actualizarMascota();
    
    // GUARDAR EN BD
    await guardarEstadoMascota();

    
    verificarSubidaNivelMascota();
    
    setTimeout(() => {
        mascota.estado = 'normal';
        restaurarVideoNormal();
        actualizarMascota();
    }, 4000);
}
function descansar() {
    limpiarMediosMascota();

    const contenedor = document.getElementById('mascota-display');
    contenedor.innerHTML = `<img src="${mascotaMedia[mascota.tipo].descansando}" class="animacion-mascota">`;

    ganarExperiencia(3);
}

// üî• FUNCI√ìN MEJORADA: Jugar con mascota CON BD
async function jugarMascota(juego) {
    if (!mascota.seleccionada) {
        mascota.mensaje = "¬°Selecciona una mascota para jugar! üéÆ";
        actualizarMascota();
        return;
    }
    
    if (mascota.energia < 15) {
        mascota.mensaje = "Estoy muy cansado... ¬øpodemos descansar un poco? üò¥";
        actualizarMascota();
        return;
    }
    
    const efectosJuegos = {
        'pelota': { felicidad: 15, energia: -12, hambre: 8 },
        'cuerda': { felicidad: 12, energia: -10, hambre: 6 },
        'pluma': { felicidad: 10, energia: -8, hambre: 5 },
        'escondite': { felicidad: 20, energia: -15, hambre: 10 }
    };
    
    const efecto = efectosJuegos[juego];
    mascota.felicidad = Math.min(100, mascota.felicidad + efecto.felicidad);
    mascota.energia = Math.max(0, mascota.energia + efecto.energia);
    mascota.hambre = Math.min(100, mascota.hambre + efecto.hambre);
    
    mascota.experiencia += 15;
    mascota.monedas += 3;
    
    mascota.mensaje = obtenerMensajePositivo('jugar', juego);
    mascota.estado = 'jugando';
    
    // MOSTRAR GIF DE JUEGO
    mostrarGifJuego(juego);
    
    actualizarMascota();
    
    // GUARDAR EN BD
    await guardarEstadoMascota();
 
    
    verificarSubidaNivelMascota();
    
    setTimeout(() => {
        mascota.estado = 'normal';
        restaurarVideoNormal();
        actualizarMascota();
    }, 3000);
}
function jugar(tipo) {
    limpiarMediosMascota();

    const contenedor = document.getElementById('mascota-display');
    contenedor.innerHTML = `<img src="${mascotaMedia[mascota.tipo].jugando[tipo]}" class="animacion-mascota">`;

    ganarExperiencia(8);
}


// üî• FUNCI√ìN MEJORADA: Verificar subida de nivel CON BD
async function verificarSubidaNivelMascota() {
    if (mascota.experiencia >= mascota.experienciaNecesaria) {
        const nivelAnterior = mascota.nivel; // üî• GUARDAR NIVEL ANTERIOR
        
        mascota.nivel++;
        mascota.experiencia = mascota.experiencia - mascota.experienciaNecesaria;
        mascota.experienciaNecesaria = Math.floor(mascota.experienciaNecesaria * 1.5);
        mascota.monedas += 25;
        mascota.felicidad = Math.min(100, mascota.felicidad + 15);
        
        mascota.mensaje = `¬°Felicidades! üéâ Sub√≠ al nivel ${mascota.nivel}. ¬°Eres el mejor due√±o! ‚ú®`;
        mascota.estado = 'feliz';
        
        // üî• MOSTRAR VIDEO DE SUBIDA DE NIVEL (NO GIF)
        if (mascota.nivel > nivelAnterior) {
            console.log(`üéâ ¬°${mascota.tipo} subi√≥ al nivel ${mascota.nivel}!`);
            mostrarVideoSubidaNivel(mascota.nivel, mascota.tipo);
        }
        
        actualizarMascota();
        
        // GUARDAR EN BD
        await guardarEstadoMascota();
        
        // üî• EL TIMEOUT YA NO ES NECESARIO PORQUE EL VIDEO MANEJA LA DURACI√ìN
        // El video se cierra autom√°ticamente cuando termina
    }
}
// =============================================
// FUNCIONES DE INTERFAZ Y ANIMACIONES
// =============================================

// üî• FUNCI√ìN PARA ACTUALIZAR INTERFAZ DE MASCOTA
function actualizarInterfazMascota() {
    const petMediaContainer = document.getElementById('pet-media-container');
    const placeholder = document.querySelector('.placeholder-mascota');
    const mediaData = mascotaMedia[mascota.tipo];
    
    // Ocultar placeholder y mostrar mascota
    if (placeholder) placeholder.style.display = 'none';
    
    if (mediaData && mediaData.video) {
        petMediaContainer.innerHTML = `
            <video autoplay loop muted class="pet-video">
                <source src="${mediaData.video}" type="video/mp4">
                Tu navegador no soporta el elemento video.
            </video>
        `;
        
        // Aplicar estilos espec√≠ficos
        setTimeout(() => {
            const video = petMediaContainer.querySelector('.pet-video');
            if (video) {
                aplicarEstilosMascota(video, mascota.tipo);
            }
        }, 100);
    } else if (mediaData) {
        petMediaContainer.innerHTML = `<img src="${mediaData.imagen}" alt="Mascota" class="pet-image">`;
    }
    
    // Ocultar selector de mascotas y mostrar panel principal
    const selectorContainer = document.querySelector('.mascota-seleccion-container');
    const activaContainer = document.getElementById('mascota-activa-container');
    
    if (selectorContainer) selectorContainer.style.display = 'none';
    if (activaContainer) activaContainer.style.display = 'block';
    
    actualizarMascota();
}

// üî• FUNCI√ìN MEJORADA: Aplicar estilos espec√≠ficos para cada mascota
function aplicarEstilosMascota(elemento, tipo) {
    // Limpiar estilos previos
    elemento.style.width = '';
    elemento.style.height = '';
    elemento.style.position = '';
    elemento.style.top = '';
    elemento.style.left = '';
    
    // Estilos base
    elemento.style.objectFit = 'cover';
    elemento.style.borderRadius = '50%';
    elemento.style.objectPosition = 'center center';
    
    // Aplicar zoom seg√∫n el tipo
    switch(tipo) {
        case 'axolote':
            elemento.style.width = '140%';
            elemento.style.height = '140%';
            elemento.style.position = 'absolute';
            elemento.style.top = '-20%';
            elemento.style.left = '-20%';
            break;
        case 'dinosaurio':
            elemento.style.width = '140%';
            elemento.style.height = '140%';
            elemento.style.position = 'absolute';
            elemento.style.top = '-20%';
            elemento.style.left = '-20%';
            break;
        case 'caracol':
            elemento.style.width = '130%';
            elemento.style.height = '130%';
            elemento.style.position = 'absolute';
            elemento.style.top = '-15%';
            elemento.style.left = '-15%';
            break;
        default:
            elemento.style.objectPosition = 'center center';
    }
}

// üî• FUNCI√ìN NUEVA: Mostrar GIF para cualquier acci√≥n
function mostrarGifAccion(accion) {
    const petMediaContainer = document.getElementById('pet-media-container');
    const mediaData = mascotaMedia[mascota.tipo];
    
    if (mediaData && mediaData[accion]) {
        const gifUrl = mediaData[accion];
        
        // Guardar el video actual para restaurarlo despu√©s
        const videoActual = petMediaContainer.innerHTML;
        petMediaContainer.setAttribute('data-video-backup', videoActual);
        
        // Mostrar el GIF
        petMediaContainer.innerHTML = `
            <img src="${gifUrl}" alt="${mascota.tipo} ${accion}" class="pet-gif">
        `;
        
        // Aplicar estilos espec√≠ficos para el GIF
        setTimeout(() => {
            const gif = petMediaContainer.querySelector('.pet-gif');
            if (gif) {
                aplicarEstilosMascota(gif, mascota.tipo);
            }
        }, 50);
    }
}

// üî• FUNCI√ìN NUEVA: Mostrar GIF del juego
function mostrarGifJuego(juego) {
    const petMediaContainer = document.getElementById('pet-media-container');
    const mediaData = mascotaMedia[mascota.tipo];
    
    if (mediaData.jugando && mediaData.jugando[juego]) {
        const gifUrl = mediaData.jugando[juego];
        
        // Guardar el video actual para restaurarlo despu√©s
        const videoActual = petMediaContainer.innerHTML;
        petMediaContainer.setAttribute('data-video-backup', videoActual);
        
        // Mostrar el GIF
        petMediaContainer.innerHTML = `
            <img src="${gifUrl}" alt="${mascota.tipo} jugando ${juego}" class="pet-gif">
        `;
        
        // Aplicar estilos espec√≠ficos para el GIF
        setTimeout(() => {
            const gif = petMediaContainer.querySelector('.pet-gif');
            if (gif) {
                aplicarEstilosMascota(gif, mascota.tipo);
            }
        }, 50);
    }
}

// üî• FUNCI√ìN MEJORADA: Restaurar video normal
function restaurarVideoNormal() {
    const petMediaContainer = document.getElementById('pet-media-container');
    const videoBackup = petMediaContainer.getAttribute('data-video-backup');
    
    if (videoBackup) {
        petMediaContainer.innerHTML = videoBackup;
        
        // Re-aplicar estilos despu√©s de restaurar
        setTimeout(() => {
            const video = petMediaContainer.querySelector('.pet-video');
            if (video) {
                aplicarEstilosMascota(video, mascota.tipo);
            }
        }, 100);
    }
}

// üî• FUNCI√ìN COMPLETAMENTE ACTUALIZADA: Actualizar la interfaz
function actualizarMascota() {
    // Actualizar estad√≠sticas
    if (document.getElementById('nivel-mascota')) {
        document.getElementById('nivel-mascota').textContent = mascota.nivel;
    }
    if (document.getElementById('experiencia-mascota')) {
        document.getElementById('experiencia-mascota').textContent = mascota.experiencia;
    }
    if (document.getElementById('monedas-mascota')) {
        document.getElementById('monedas-mascota').textContent = mascota.monedas;
    }
    if (document.getElementById('nivel-felicidad')) {
        document.getElementById('nivel-felicidad').textContent = mascota.felicidad;
    }
    if (document.getElementById('nivel-energia')) {
        document.getElementById('nivel-energia').textContent = mascota.energia;
    }
    if (document.getElementById('nivel-hambre')) {
        document.getElementById('nivel-hambre').textContent = mascota.hambre;
    }
    
    // ACTUALIZAR BARRA DE EXPERIENCIA CORRECTAMENTE
    const porcentajeExperiencia = (mascota.experiencia / mascota.experienciaNecesaria) * 100;
    const barraExperiencia = document.getElementById('barra-experiencia');
    const textoExperiencia = document.getElementById('experiencia-texto');
    
    if (barraExperiencia) {
        barraExperiencia.style.width = `${Math.min(100, porcentajeExperiencia)}%`;
    }
    if (textoExperiencia) {
        textoExperiencia.textContent = `${mascota.experiencia}/${mascota.experienciaNecesaria}`;
    }
    
    // Actualizar mensaje de estado
    if (document.getElementById('estado-mascota')) {
        document.getElementById('estado-mascota').textContent = mascota.mensaje;
    }
    
    // Actualizar clases de estado
    const mascotaElemento = document.getElementById('mascota-actual');
    if (mascotaElemento) {
        // Remover todas las clases de estado anteriores
        mascotaElemento.classList.remove('descansando', 'jugando', 'feliz', 'comiendo', 'acariciando');
        
        // Agregar clase seg√∫n el estado actual
        if (mascota.estado && mascota.estado !== 'normal') {
            mascotaElemento.classList.add(mascota.estado);
        }
    }
}

// =============================================
// INICIALIZACI√ìN
// =============================================

// Inicializar
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üêæ Inicializando mascota virtual...');
    
    // Intentar cargar mascota existente desde la BD
    const tieneMascota = await cargarMascotaExistente();
    
    if (!tieneMascota) {
        // Mostrar selector de mascotas
        mascota.mensaje = '¬°Selecciona tu mascota para comenzar!';
        actualizarMascota();
        
        // Asegurarse de que el selector est√© visible
        const selectorContainer = document.querySelector('.mascota-seleccion-container');
        const activaContainer = document.getElementById('mascota-activa-container');
        
        if (selectorContainer) selectorContainer.style.display = 'block';
        if (activaContainer) activaContainer.style.display = 'none';
    }
    
    console.log('‚úÖ Mascota virtual inicializada');
});

// =============================================
// FUNCIONES DE DEBUG (OPCIONAL)
// =============================================

// Funci√≥n de debug para ver el estado actual
function debugMascota() {
    console.log('Estado actual de la mascota:', mascota);
    alert(`Estado de la mascota:
Tipo: ${mascota.tipo}
Seleccionada: ${mascota.seleccionada}
Nivel: ${mascota.nivel}
Experiencia: ${mascota.experiencia}/${mascota.experienciaNecesaria}
Monedas: ${mascota.monedas}
Felicidad: ${mascota.felicidad}
Energ√≠a: ${mascota.energia}
Hambre: ${mascota.hambre}
Estado: ${mascota.estado}
Mensaje: ${mascota.mensaje}`);
}

// Funci√≥n para probar conexi√≥n con la API
async function testConexion() {
    try {
        const resultado = await apiCall('/health');
        if (resultado) {
            alert('‚úÖ Conexi√≥n con la API exitosa');
            console.log('Estado de la API:', resultado);
        } else {
            alert('‚ùå No se pudo conectar con la API');
        }
    } catch (error) {
        alert('‚ùå Error en la conexi√≥n: ' + error.message);
    }
}

// =============================================
// üî• LIMPIADOR GENERAL DE MEDIOS (VIDEOS + GIFS + IM√ÅGENES)
// =============================================
function limpiarMediosMascota() {
    console.log("üßπ Limpiando medios visuales...");

    // 1Ô∏è‚É£ DETENER Y REINICIAR TODOS LOS VIDEOS
    const videos = document.querySelectorAll("video");
    videos.forEach(video => {
        try {
            video.pause();
            video.currentTime = 0;

            // Ocultarlo si est√° en pantalla
            video.style.display = "none";
        } catch (e) {
            console.warn("‚ö† No se pudo limpiar video:", e);
        }
    });

    // 2Ô∏è‚É£ REINICIAR TODAS LAS IM√ÅGENES (incluye GIFs)
    const imagenes = document.querySelectorAll("img, .gif-mascota");
    imagenes.forEach(img => {
        try {
            const src = img.src;
            img.src = "";
            img.offsetHeight; // Forzar reflow
            img.src = src;
        } catch (e) {
            console.warn("‚ö† No se pudo reiniciar imagen/gif:", e);
        }
    });

    // 3Ô∏è‚É£ CERRAR MODALES DE VIDEO (tu modal de subida de nivel)
    const modal = document.getElementById("modal-video-nivel");
    if (modal) {
        try {
            modal.remove();
            videoEnReproduccion = false;
        } catch (e) {
            console.warn("‚ö† No se pudo cerrar modal:", e);
        }
    }

    console.log("‚úÖ Medios limpiados correctamente");
}




 


    // =============================================
    // CARGA DE DATOS DEL USUARIO - CONEXI√ìN BD
    // =============================================

    async function loadUserData() {
        try {
            // Cargar emociones desde BD
            const emocionesData = await apiRequest('/emociones');
            emociones = emocionesData.map(e => ({
                tipo: e.TipoEmocion,
                fecha: new Date(e.FechaRegistro).toLocaleDateString(),
                hora: new Date(e.FechaRegistro).toLocaleTimeString(),
                notas: e.Nota
            }));
            
            // Cargar mascota desde BD
            const mascotaData = await apiRequest('/mascotas');
            if (mascotaData.mascota) {
                mascota.tipo = mascotaData.mascota.Tipo;
                mascota.seleccionada = true;
                
                // Ocultar selector y mostrar mascota activa
                document.querySelector('.mascota-seleccion-container').style.display = 'none';
                document.getElementById('mascota-activa-container').style.display = 'block';
                
                // Actualizar opci√≥n seleccionada
                document.querySelectorAll('.pet-option-card').forEach(opcion => {
                    if (opcion.getAttribute('data-pet') === mascotaData.mascota.Tipo) {
                        opcion.classList.add('selected');
                    } else {
                        opcion.style.display = 'none';
                    }
                });
            }
            
            // Cargar retos desde localStorage (temporal)
            retos = JSON.parse(localStorage.getItem('retos')) || [];
            actualizarListaRetos();
            
            // Cargar estad√≠sticas de respiraci√≥n
            const sesiones = localStorage.getItem('sesionesRespiracion') || '0';
            const dias = localStorage.getItem('diasConsecutivos') || '0';
            
            if (document.getElementById('sesiones-completadas')) {
                document.getElementById('sesiones-completadas').textContent = sesiones;
            }
            if (document.getElementById('dias-consecutivos')) {
                document.getElementById('dias-consecutivos').textContent = dias;
            }
            
            // Actualizar interfaz
            actualizarEstadisticas();
            if (typeof inicializarCalendario === 'function') inicializarCalendario();
            setTimeout(inicializarGraficos, 500);
            actualizarMascota();
            updateProfileStats();
            
        } catch (error) {
            console.error('Error cargando datos:', error);
            // Fallback: cargar desde localStorage si hay error de BD
            emociones = JSON.parse(localStorage.getItem('emociones')) || [];
            retos = JSON.parse(localStorage.getItem('retos')) || [];
        }
    }

    function limpiarMediosMascota() {
    const contenedor = document.getElementById('mascota-display');

    if (!contenedor) return;

    const elementos = contenedor.querySelectorAll("img, video");

    elementos.forEach(el => {
        if (el.tagName === "VIDEO") {
            el.pause();
            el.src = "";
        }
        el.remove();
    });

    contenedor.innerHTML = "";
}


    
    // ======================================================
    // INICIALIZACI√ìN GLOBAL
    // ======================================================
    window.addEventListener('load', function() {
        // Verificar si hay usuario logueado
        const authToken = localStorage.getItem('authToken');
        const user = localStorage.getItem('user');
        
        if (authToken || user) {
            mostrarPantalla('main-app');
            updateUserInfo();
            loadUserData();
            setupUserAvatar();
        } else {
            mostrarPantalla('welcome-screen');
        }

       
        
        // Inicializar componentes
        if (typeof inicializarCalendario === 'function') inicializarCalendario();
        setTimeout(inicializarGraficos, 500);
    });

    


    document.addEventListener('DOMContentLoaded', async function() {
    // Inicializar eventos de selecci√≥n
    document.querySelectorAll('.emotion').forEach(emotion => {
        emotion.addEventListener('click', function() {
            document.querySelectorAll('.emotion').forEach(e => e.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    // üîπ Cargar emociones desde la BD al iniciar
    await cargarEmocionesDesdeBD();

    // üîπ Inicializar todos los componentes visuales
    if (typeof inicializarGraficos === 'function') inicializarGraficos();
    if (typeof actualizarEstadisticas === 'function') actualizarEstadisticas();
    if (typeof generarCalendario === 'function') generarCalendario(mesActual, a√±oActual);
});

// Funci√≥n para debug
function agregarBotonDebug() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = 'Debug Info';
    debugBtn.style.position = 'fixed';
    debugBtn.style.bottom = '10px';
    debugBtn.style.right = '10px';
    debugBtn.style.zIndex = '1000';
    debugBtn.style.padding = '10px';
    debugBtn.style.backgroundColor = '#007bff';
    debugBtn.style.color = 'white';
    debugBtn.style.border = 'none';
    debugBtn.style.borderRadius = '5px';
    debugBtn.style.cursor = 'pointer';
    
    debugBtn.addEventListener('click', function() {
        console.log('=== DEBUG INFO ===');
        console.log('User ID:', getUserID());
        console.log('Token:', localStorage.getItem('authToken'));
        console.log('Emociones en localStorage:', localStorage.getItem('emocionesUsuario'));
        console.log('Mascota en localStorage:', localStorage.getItem('mascotaVirtual'));
    });
    
    document.body.appendChild(debugBtn);
}

// Funci√≥n para inicializar gr√°ficos
function inicializarGraficos() {
    console.log('üìà Inicializando gr√°ficos...');
    try {
        // Aqu√≠ va tu l√≥gica de gr√°ficos
        console.log('‚úÖ Gr√°ficos inicializados');
    } catch (error) {
        console.error('‚ùå Error inicializando gr√°ficos:', error);
    }
}




</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

</body>

</html>